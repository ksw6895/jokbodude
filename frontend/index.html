<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JokboDude - Professional PDF Analysis Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      :root { --bg: #0D1117; --bg-elevated: #161B22; --border-color: #30363D; --text-primary: #C9D1D9; --text-secondary: #8B949E; }
      body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); }
      .aurora-background { position: fixed; inset: 0; pointer-events: none; z-index: -1; background: radial-gradient(circle at 10% 20%, rgba(58,122,255,.10), transparent 40%), radial-gradient(circle at 90% 80%, rgba(110,86,255,.10), transparent 40%), radial-gradient(circle at 50% 50%, rgba(30,190,255,.08), transparent 50%); filter: blur(80px); }
      .glass-card { background: rgba(22,27,34,.70); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid var(--border-color); border-radius: 16px; }
      .hero-title-gradient { background: linear-gradient(90deg, #E1E8EF, #A6C5E3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .tab.active { background-color: #58A6FF; color: #0D1117; font-weight: 600; }
      .file-upload-area { transition: all .3s ease; }
      .file-upload-area.dragover { border-color: #58A6FF; transform: scale(1.02); box-shadow: 0 0 20px rgba(88,166,255,.2); }
      .tab-content { display: none; }
      .tab-content.active { display: block; animation: fadeIn .3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity:1; transform: translateY(0); } }
      .help-panel { max-height: 0; overflow: hidden; transition: max-height .3s ease, padding .3s ease, margin .3s ease; padding-top:0; padding-bottom:0; margin-top:0; }
      .help-panel.show { margin-top: .5rem; padding-top: .75rem; padding-bottom: .75rem; }
      /* JS-targeted elements */
      .status-badge { border: 1px solid #30363D; background: rgba(0,0,0,0.3); color: #9aa4af; padding: .25rem .6rem; border-radius: 9999px; font-weight: 800; font-size: .8rem; }
      .status-badge.idle { color: #9aa4af; }
      .status-badge.processing { color: #e3b341; border-color: #3a3320; }
      .status-badge.success { color: #42c386; border-color: #204732; }
      .status-badge.error { color: #ef6363; border-color: #4a2222; }
      .progress-bar { border: 1px solid #30363D; background: #0b0f14; border-radius: 9999px; overflow: hidden; }
      .progress-fill { background: linear-gradient(90deg, #dcdcdc, #8d8d8d); height: 8px; width: 0%; transition: width .3s ease; }
      .loader { display:inline-block; width: 20px; height: 20px; border: 3px solid #1c1f24; border-top-color: #bbb; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .file-item { display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; padding:.5rem .6rem; border:1px solid #30363D; border-radius:8px; background:#12151a; }
      .file-remove { padding:.25rem .5rem; border:1px solid #30363D; background: rgba(255,255,255,0.06); border-radius:6px; cursor:pointer; color:#ef6363; }
    </style>
    <!-- legacy stylesheet left temporarily during migration; will be removed -->
    <link rel="stylesheet" href="styles.css?v=5">
</head>
<body>
    <nav class="sticky top-0 z-50 bg-black/30 backdrop-blur-lg border-b border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <a href="/" class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gray-800 border border-gray-700 rounded-lg flex items-center justify-center text-xl">🎓</div>
            <span class="text-white text-2xl font-bold">JokboDude</span>
          </a>
          <div class="flex items-center gap-2 md:gap-4">
            <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" id="my_jobs_link" href="/profile" style="display:none;">My Jobs</a>
            <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" href="/guide">Guide</a>
            <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" id="feedback_link" href="#" style="display:none;">Feedback</a>
            <div id="auth_area" class="flex items-center gap-2">
              <span id="user_badge" style="display:none;" class="px-3 py-1.5 border border-gray-700 rounded-full bg-gray-800/50 text-xs text-gray-300"></span>
              <span id="token_badge" style="display:none;" class="px-3 py-1.5 border border-gray-700 rounded-full bg-gray-800/50 text-xs text-gray-300">Tokens: -</span>
              <button id="login_btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">Sign in</button>
              <div id="gsi_btn" style="display:none;"></div>
              <button id="logout_btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-colors" style="display:none;">Logout</button>
              <button id="clear_cache_btn" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-colors" style="display:none;" title="Clear cache and debug files">Clear Cache</button>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="aurora-background"></div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="text-center py-12 md:py-20">
            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight hero-title-gradient">AI-Powered PDF Analysis</h1>
            <p class="mt-4 max-w-2xl mx-auto text-lg md:text-xl text-gray-400">Transform your study materials with intelligent document analysis using Google Gemini AI</p>
            <a href="#start" class="mt-8 inline-block bg-blue-600 text-white font-bold text-lg px-8 py-4 rounded-full shadow-lg shadow-blue-500/20 hover:bg-blue-500 transform hover:-translate-y-1 transition-all duration-300">Start Analysis →</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 my-16">
            <div class="glass-card p-6 flex flex-col items-start hover:border-blue-500/50 transition-colors duration-300">
                <div class="p-3 bg-gray-800 border border-gray-700 rounded-lg text-2xl mb-4">🚀</div>
                <h3 class="text-lg font-bold text-white mb-2">Fast Processing</h3>
                <p class="text-sm text-gray-400">Analyze multiple PDFs simultaneously with our optimized processing engine</p>
            </div>
            <div class="glass-card p-6 flex flex-col items-start hover:border-blue-500/50 transition-colors duration-300">
                <div class="p-3 bg-gray-800 border border-gray-700 rounded-lg text-2xl mb-4">🎯</div>
                <h3 class="text-lg font-bold text-white mb-2">Smart Matching</h3>
                <p class="text-sm text-gray-400">AI automatically matches exam questions with relevant lecture content</p>
            </div>
            <div class="glass-card p-6 flex flex-col items-start hover:border-blue-500/50 transition-colors duration-300">
                <div class="p-3 bg-gray-800 border border-gray-700 rounded-lg text-2xl mb-4">💎</div>
                <h3 class="text-lg font-bold text-white mb-2">Gemini Model</h3>
                <p class="text-sm text-gray-400">Uses Gemini 2.5 Flash for balanced speed and quality</p>
            </div>
            <div class="glass-card p-6 flex flex-col items-start hover:border-blue-500/50 transition-colors duration-300">
                <div class="p-3 bg-gray-800 border border-gray-700 rounded-lg text-2xl mb-4">📊</div>
                <h3 class="text-lg font-bold text-white mb-2">Detailed Analysis</h3>
                <p class="text-sm text-gray-400">Get comprehensive explanations and relevance scores for each match</p>
            </div>
        </div>

        <div class="glass-card" id="start">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-2xl font-bold text-white">Start Your Analysis</h2>
                <p class="mt-1 text-gray-400">Upload your PDF files and let our AI do the work</p>
                <div id="token_info_line" class="mt-2 text-xs text-gray-500" style="display:none;"></div>
            </div>
            
            <div class="p-6">
                <!-- Model password removed; Pro access is token-based -->
                <div class="flex p-1 bg-gray-900/70 border border-gray-700 rounded-xl mb-6">
                    <button class="tab w-1/3 py-2 px-3 text-sm rounded-lg text-gray-300 hover:bg-gray-800 active" onclick="switchTab('jokbo', event)">Exam-Centric Analysis</button>
                    <button class="tab w-1/3 py-2 px-3 text-sm rounded-lg text-gray-300 hover:bg-gray-800" onclick="switchTab('lesson', event)">Lecture-Centric Analysis</button>
                    <button class="tab w-1/3 py-2 px-3 text-sm rounded-lg text-gray-300 hover:bg-gray-800" onclick="switchTab('partial', event)">Partial Jokbo Analysis</button>
                </div>
                
                <!-- Jokbo-Centric Tab (Tailwind) -->
                <div id="jokbo-tab" class="tab-content active">
                    <form id="jokboForm" class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Configuration</h3>
                                <button type="button" class="tab px-2 py-1 rounded-md text-sm" aria-expanded="false" data-help-target="jokbo_help">모드 설명</button>
                            </div>
                            <div id="jokbo_help" class="help-panel">
                                <div class="text-white font-semibold">Exam-Centric Analysis</div>
                                <div class="text-gray-400">하나의 족보를 중심으로 여러 강의자료를 매칭하여, 각 문제에 가장 관련성 높은 슬라이드 근거를 첨부합니다. 멀티 API를 사용하면 병렬 처리로 더 빠르게 진행됩니다.</div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label for="jokbo_model" class="block text-sm font-medium text-gray-300 mb-1">AI Model</label>
                                    <select id="jokbo_model" name="model" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                        <option value="flash" selected>Gemini 2.5 Flash - Balanced</option>
                                        <option value="pro">Gemini 2.5 Pro - Quality</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="jokbo_min_rel" class="block text-sm font-medium text-gray-300 mb-1">Min Relevance Score</label>
                                    <div class="flex items-center gap-4">
                                        <input id="jokbo_min_rel" type="range" min="0" max="110" value="70" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                        <output id="jokbo_min_rel_out" for="jokbo_min_rel" class="font-semibold text-blue-400 w-8 text-right">70</output>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Processing Mode</label>
                                    <div class="flex items-center gap-2">
                                        <div id="jokbo_multi_api_group" class="inline-flex rounded-md shadow-sm bg-gray-900 border border-gray-700">
                                            <button type="button" data-value="single" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-l-md text-xs font-medium text-gray-400 hover:bg-gray-800">Single API</button>
                                            <button type="button" data-value="multi" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-r-md text-xs font-medium text-gray-400 hover:bg-gray-800">Multi-API</button>
                                        </div>
                                        <span id="jokbo_multi_api_note" class="text-xs text-gray-500"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">File Upload</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Exam PDFs</label>
                                    <input type="file" id="jokbo_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('jokbo_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📄</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="jokbo_error"></div>
                                    <div class="mt-4 space-y-2" id="jokbo_file_list"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Lecture PDFs</label>
                                    <input type="file" id="jokbo_lesson_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('jokbo_lesson_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📚</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="jokbo_lesson_error"></div>
                                    <div class="mt-4 space-y-2" id="jokbo_lesson_file_list"></div>
                                </div>
                            </div>
                        </div>

                        <div id="jokbo_estimate" class="text-xs text-gray-400"></div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-blue-500/20 hover:bg-blue-500 transform hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2">Start Exam-Centric Analysis →</button>
                        </div>
                    </form>
                </div>

                <!-- Lesson-Centric Tab (Tailwind) -->
                <div id="lesson-tab" class="tab-content">
                    <form id="lessonForm" class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Configuration</h3>
                                <button type="button" class="tab px-2 py-1 rounded-md text-sm" aria-expanded="false" data-help-target="lesson_help">모드 설명</button>
                            </div>
                            <div id="lesson_help" class="help-panel">
                                <div class="text-white font-semibold">Lecture-Centric Analysis</div>
                                <div class="text-gray-400">강의 슬라이드 각각에 대해 가장 연관 있는 문제를 매칭해 해설과 함께 구성합니다. 슬라이드 순서를 유지합니다.</div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label for="lesson_model" class="block text-sm font-medium text-gray-300 mb-1">AI Model</label>
                                    <select id="lesson_model" name="model" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                        <option value="flash" selected>Gemini 2.5 Flash - Balanced</option>
                                        <option value="pro">Gemini 2.5 Pro - Quality</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="lesson_min_rel" class="block text-sm font-medium text-gray-300 mb-1">Min Relevance Score</label>
                                    <div class="flex items-center gap-4">
                                        <input id="lesson_min_rel" type="range" min="0" max="110" value="70" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                        <output id="lesson_min_rel_out" for="lesson_min_rel" class="font-semibold text-blue-400 w-8 text-right">70</output>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Processing Mode</label>
                                    <div class="flex items-center gap-2">
                                        <div id="lesson_multi_api_group" class="inline-flex rounded-md shadow-sm bg-gray-900 border border-gray-700">
                                            <button type="button" data-value="single" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-l-md text-xs font-medium text-gray-400 hover:bg-gray-800">Single API</button>
                                            <button type="button" data-value="multi" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-r-md text-xs font-medium text-gray-400 hover:bg-gray-800">Multi-API</button>
                                        </div>
                                        <span id="lesson_multi_api_note" class="text-xs text-gray-500"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">File Upload</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Lecture PDFs</label>
                                    <input type="file" id="lesson_lesson_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('lesson_lesson_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📚</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="lesson_lesson_error"></div>
                                    <div class="mt-4 space-y-2" id="lesson_lesson_file_list"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Exam PDFs</label>
                                    <input type="file" id="lesson_jokbo_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('lesson_jokbo_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📄</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="lesson_jokbo_error"></div>
                                    <div class="mt-4 space-y-2" id="lesson_jokbo_file_list"></div>
                                </div>
                            </div>
                        </div>

                        <div id="lesson_estimate" class="text-xs text-gray-400"></div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-blue-500/20 hover:bg-blue-500 transform hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2">Start Lecture-Centric Analysis →</button>
                        </div>
                    </form>
                </div>

                <!-- Partial Jokbo Tab (Tailwind) -->
                <div id="partial-tab" class="tab-content">
                    <form id="partialForm" class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Configuration</h3>
                                <button type="button" class="tab px-2 py-1 rounded-md text-sm" aria-expanded="false" data-help-target="partial_help">모드 설명</button>
                            </div>
                            <div id="partial_help" class="help-panel">
                                <div class="text-white font-semibold">Partial Jokbo Analysis</div>
                                <div class="text-gray-400">문제 영역만 추출해 간단한 해설과 함께 빠른 복습용 PDF로 만듭니다.</div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label for="partial_model" class="block text-sm font-medium text-gray-300 mb-1">AI Model</label>
                                    <select id="partial_model" name="model" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                        <option value="flash" selected>Gemini 2.5 Flash - Balanced</option>
                                        <option value="pro">Gemini 2.5 Pro - Quality</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="partial_min_rel" class="block text-sm font-medium text-gray-300 mb-1">Min Relevance Score</label>
                                    <div class="flex items-center gap-4">
                                        <input id="partial_min_rel" type="range" min="0" max="110" value="70" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                        <output id="partial_min_rel_out" for="partial_min_rel" class="font-semibold text-blue-400 w-8 text-right">70</output>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Processing Mode</label>
                                    <div class="flex items-center gap-2">
                                        <div id="partial_multi_api_group" class="inline-flex rounded-md shadow-sm bg-gray-900 border border-gray-700">
                                            <button type="button" data-value="single" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-l-md text-xs font-medium text-gray-400 hover:bg-gray-800">Single API</button>
                                            <button type="button" data-value="multi" class="toggle-option relative inline-flex items-center px-4 py-2 rounded-r-md text-xs font-medium text-gray-400 hover:bg-gray-800">Multi-API</button>
                                        </div>
                                        <span id="partial_multi_api_note" class="text-xs text-gray-500"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">File Upload</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Exam PDFs</label>
                                    <input type="file" id="partial_jokbo_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('partial_jokbo_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📄</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="partial_jokbo_error"></div>
                                    <div class="mt-4 space-y-2" id="partial_jokbo_file_list"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Lecture PDFs</label>
                                    <input type="file" id="partial_lesson_files" multiple accept=".pdf" class="hidden">
                                    <div class="file-upload-area p-6 text-center border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-blue-500" onclick="document.getElementById('partial_lesson_files').click()">
                                        <div class="mx-auto h-12 w-12 text-gray-500">📚</div>
                                        <p class="mt-2 text-sm text-gray-400">Click or drag files here</p>
                                        <p class="text-xs text-gray-500">PDF, up to 50MB each</p>
                                    </div>
                                    <div class="text-red-400 text-xs mt-2" id="partial_lesson_error"></div>
                                    <div class="mt-4 space-y-2" id="partial_lesson_file_list"></div>
                                </div>
                            </div>
                        </div>
                        <div id="partial_estimate" class="text-xs text-gray-400"></div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-blue-500/20 hover:bg-blue-500 transform hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2">Start Partial Jokbo Analysis →</button>
                        </div>
                    </form>
                </div>

                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-white">Processing Status</h3>
                        <span id="status-badge" class="status-badge idle">IDLE</span>
                    </div>
                    <div id="status-content" class="bg-gray-900/70 border border-gray-800 rounded-lg p-6 min-h-[120px] flex items-center justify-center text-center">
                        <p id="status-message" class="text-gray-400">Ready to process your files.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card mt-4">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white">My Jobs</h2>
                <p class="text-gray-400">View your recent jobs</p>
            </div>
            <div class="p-6">
                <button id="load_jobs_btn" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-colors mb-4">Load My Jobs</button>
                <div id="jobs_list" class="bg-gray-900/70 border border-gray-800 rounded-lg p-4 min-h-[80px]" style="display:block;align-items:stretch;justify-content:flex-start;"></div>
            </div>
        </div>

        <div class="glass-card mt-4">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-bold text-white">Admin Tools</h2>
                <p class="text-gray-400">Admin via Google account (ADMIN_EMAILS) or password fallback</p>
            </div>
            <div class="p-6">
                <div id="admin_sections" style="display:none;">
                    <div class="form-section" style="border-bottom:1px solid var(--border);padding-bottom:1rem;margin-bottom:1rem;">
                        <h3 class="form-section-title">Tester Allowlist</h3>
                        <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
                            <input type="email" id="tester_email" placeholder="Add tester email" style="min-width:260px;padding:.5rem .75rem;border:1px solid var(--border);border-radius:8px;"/>
                            <button id="add_tester_btn" class="tab">Add Tester</button>
                            <button id="reload_testers_btn" class="tab" title="Refresh list">Reload</button>
                        </div>
                        <div id="testers_list" class="status-content" style="display:block;align-items:stretch;justify-content:flex-start;margin-top:.75rem;padding:.75rem;min-height:auto;"></div>
                    </div>
                    <div class="form-section">
                        <h3 class="form-section-title">User Tokens</h3>
                        <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
                            <input type="email" id="user_search_email" placeholder="Search by email (exact)" style="min-width:260px;padding:.5rem .75rem;border:1px solid var(--border);border-radius:8px;"/>
                            <button id="search_users_btn" class="tab">Search</button>
                            <button id="list_users_btn" class="tab">List Recent</button>
                        </div>
                        <div id="users_list" class="status-content" style="display:block;align-items:stretch;justify-content:flex-start;margin-top:.75rem;padding:.75rem;min-height:auto;"></div>
                    </div>
                </div>
                <div class="form-section" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
                    <div class="form-group" style="min-width:260px;">
                        <label for="admin_password">Admin Password</label>
                        <input type="password" id="admin_password" placeholder="Enter admin password" style="width:100%;padding:0.5rem 1rem;border:1px solid var(--gray-300);border-radius:8px;" />
                        <div class="form-hint text-gray-500" style="font-size: 0.85rem; margin-top: 0.25rem;">Optional if signed in as admin (ADMIN_EMAILS)</div>
                    </div>
                    <button id="save_admin_pw_btn" class="tab" style="height:40px;">Save</button>
                </div>
                <div class="form-section" style="display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center;margin-top:0.75rem;">
                    <label for="older_hours">Delete only files older than (hours)</label>
                    <input id="older_hours" type="number" min="1" placeholder="e.g. 168" style="width:140px;padding:0.5rem 0.75rem;border:1px solid var(--gray-300);border-radius:8px;" />
                    <button id="run_cleanup_btn" class="tab">Run Cleanup</button>
                    <button id="show_stats_btn" class="tab">Show Storage Stats</button>
                    <button id="prune_24h_btn" class="tab" title="Prune files older than 24h in RENDER_STORAGE_PATH">Prune 24h (Results + Storage)</button>
                </div>
                <pre id="admin_output" style="margin-top:1rem;background:rgba(0,0,0,0.25);padding:0.75rem;border-radius:8px;max-height:240px;overflow:auto;color:#ccc;"></pre>
            </div>
        </div>
    </div>
    
    <script>
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
        let JD_CONFIG = { multi_api_available: false, api_keys_count: 0 };
        // Pro model no longer requires a password; token-based
        // Staged file buckets to allow incremental adds and removals per input
        const stagedFiles = {
            'jokbo_files': [],
            'jokbo_lesson_files': [],
            'lesson_lesson_files': [],
            'lesson_jokbo_files': [],
            'partial_jokbo_files': [],
            'partial_lesson_files': []
        };

        // Initialize processing mode toggles with server capabilities
        async function initConfigAndToggles() {
            try {
                const res = await fetch('/config', { credentials: 'include' });
                if (res.ok) {
                    JD_CONFIG = await res.json();
                }
            } catch (e) { /* ignore; use defaults */ }

            initProcessingToggle(
                'jokbo_multi_api_group',
                'jokbo_multi_api_note',
                'jd_multi_api_jokbo',
                JD_CONFIG.multi_api_available,
                JD_CONFIG.api_keys_count
            );
            initProcessingToggle(
                'lesson_multi_api_group',
                'lesson_multi_api_note',
                'jd_multi_api_lesson',
                JD_CONFIG.multi_api_available,
                JD_CONFIG.api_keys_count
            );
            initProcessingToggle(
                'partial_multi_api_group',
                'partial_multi_api_note',
                'jd_multi_api_partial',
                JD_CONFIG.multi_api_available,
                JD_CONFIG.api_keys_count
            );
        }

        function initProcessingToggle(groupId, noteId, storageKey, available, keysCount) {
            const group = document.getElementById(groupId);
            const note = document.getElementById(noteId);
            const [singleBtn, multiBtn] = group.querySelectorAll('.toggle-option');

            // Show availability note
            if (available) {
                note.textContent = `· ${keysCount} API keys available`;
                multiBtn.classList.remove('disabled');
            } else {
                note.textContent = '· Multi-API unavailable (1 key)';
                multiBtn.classList.add('disabled');
            }

            // Restore saved preference; default to available? true : false
            const saved = localStorage.getItem(storageKey);
            const preferMulti = saved !== null ? (saved === 'true') : !!available;
            setToggleActive(singleBtn, multiBtn, preferMulti && available);

            // Helper to trigger preflight estimate when toggles change
            const triggerPreflight = () => {
                try {
                    if (!CURRENT_USER) return;
                    if (groupId === 'jokbo_multi_api_group') {
                        const model = document.getElementById('jokbo_model').value;
                        maybePreflight('jokbo-centric', 'jokbo_files', 'jokbo_lesson_files', model);
                    } else if (groupId === 'lesson_multi_api_group') {
                        const model = document.getElementById('lesson_model').value;
                        maybePreflight('lesson-centric', 'lesson_jokbo_files', 'lesson_lesson_files', model);
                    } else if (groupId === 'partial_multi_api_group') {
                        const model = document.getElementById('partial_model').value;
                        maybePreflight('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
                    }
                } catch {}
            };

            // Wire up clicks
            singleBtn.onclick = () => {
                setToggleActive(singleBtn, multiBtn, false);
                localStorage.setItem(storageKey, 'false');
                triggerPreflight();
            };
            multiBtn.onclick = () => {
                if (multiBtn.classList.contains('disabled')) return;
                setToggleActive(singleBtn, multiBtn, true);
                localStorage.setItem(storageKey, 'true');
                triggerPreflight();
            };
        }

        function setToggleActive(singleBtn, multiBtn, useMulti) {
            if (useMulti) {
                singleBtn.classList.remove('active');
                multiBtn.classList.add('active');
            } else {
                multiBtn.classList.remove('active');
                singleBtn.classList.add('active');
            }
        }

        function getMultiApiState(mode) {
            let groupId = 'jokbo_multi_api_group';
            if (mode === 'lesson-centric') groupId = 'lesson_multi_api_group';
            if (mode === 'partial-jokbo') groupId = 'partial_multi_api_group';
            const group = document.getElementById(groupId);
            const [singleBtn, multiBtn] = group.querySelectorAll('.toggle-option');
            return multiBtn.classList.contains('active') && !multiBtn.classList.contains('disabled');
        }

        // Pro model is always available; /config determines only multi-api availability
        
        // Tab switching
        function switchTab(tabName, evt) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const e = evt || window.event;
            if (e && e.target) e.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // File handling
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function handleFileSelect(inputId, listId, errorId) {
            const input = document.getElementById(inputId);
            const fileList = document.getElementById(listId);
            const errorElement = document.getElementById(errorId);
            const uploadArea = input.nextElementSibling;
            
            fileList.innerHTML = '';
            errorElement.classList.remove('show');
            
            if (input.files.length === 0) {
                uploadArea.classList.remove('active');
                return;
            }
            
            uploadArea.classList.add('active');
            let hasError = false;
            
            Array.from(input.files).forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const isOversized = file.size > MAX_FILE_SIZE;
                if (isOversized) hasError = true;
                
                fileItem.innerHTML = `
                    <div>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size ${isOversized ? 'error' : ''}">${formatFileSize(file.size)}</span>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            if (hasError) {
                errorElement.textContent = '⚠️ Some files exceed the 50MB limit';
                errorElement.classList.add('show');
            }
        }
        
        // Kick off config fetch and toggle init
        initConfigAndToggles();

        // Staged file selection helpers (allow multi-step add/remove)
        function addFilesToBucket(inputId, files, errorId) {
            const bucket = stagedFiles[inputId];
            const errorElement = document.getElementById(errorId);
            let hasError = false;
            for (const f of files) {
                if (f.size > MAX_FILE_SIZE) { hasError = true; continue; }
                const exists = bucket.some(b => b.name === f.name && b.size === f.size && b.lastModified === f.lastModified);
                if (!exists) bucket.push(f);
            }
            if (hasError) {
                errorElement.textContent = '⚠️ Some files exceeded 50MB and were skipped';
                errorElement.classList.add('show');
            } else {
                errorElement.classList.remove('show');
            }
        }
        function renderBucket(inputId, listId) {
            const input = document.getElementById(inputId);
            const uploadArea = input.nextElementSibling;
            const fileList = document.getElementById(listId);
            const bucket = stagedFiles[inputId] || [];
            fileList.innerHTML = '';
            if (bucket.length === 0) {
                uploadArea.classList.remove('active');
                return;
            }
            uploadArea.classList.add('active');
            bucket.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size/1024/1024).toFixed(2)} MB</span>
                    </div>
                    <button type="button" class="file-remove" data-bucket="${inputId}" data-index="${index}" title="Remove">✕</button>
                `;
                fileList.appendChild(fileItem);
            });
        }
        function handleFileSelectStaged(inputId, listId, errorId) {
            const input = document.getElementById(inputId);
            if (input.files && input.files.length > 0) {
                addFilesToBucket(inputId, Array.from(input.files), errorId);
                input.value = '';
            }
            renderBucket(inputId, listId);
        }
        function removeFileFromBucket(bucketId, index, listId) {
            const arr = stagedFiles[bucketId] || [];
            if (index >= 0 && index < arr.length) {
                arr.splice(index, 1);
                renderBucket(bucketId, listId);
            }
        }

        // Attach file handlers (use staged logic)
        document.getElementById('jokbo_files').addEventListener('change', () => 
            handleFileSelectStaged('jokbo_files', 'jokbo_file_list', 'jokbo_error'));
        document.getElementById('jokbo_lesson_files').addEventListener('change', () => 
            handleFileSelectStaged('jokbo_lesson_files', 'jokbo_lesson_file_list', 'jokbo_lesson_error'));
        document.getElementById('lesson_lesson_files').addEventListener('change', () => 
            handleFileSelectStaged('lesson_lesson_files', 'lesson_lesson_file_list', 'lesson_lesson_error'));
        document.getElementById('lesson_jokbo_files').addEventListener('change', () =>
            handleFileSelectStaged('lesson_jokbo_files', 'lesson_jokbo_file_list', 'lesson_jokbo_error'));
        document.getElementById('partial_jokbo_files').addEventListener('change', () =>
            handleFileSelectStaged('partial_jokbo_files', 'partial_jokbo_file_list', 'partial_jokbo_error'));
        document.getElementById('partial_lesson_files').addEventListener('change', () =>
            handleFileSelectStaged('partial_lesson_files', 'partial_lesson_file_list', 'partial_lesson_error'));
        // Removal handlers via event delegation
        document.getElementById('jokbo_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'jokbo_file_list');
            }
        });
        document.getElementById('jokbo_lesson_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'jokbo_lesson_file_list');
            }
        });
        document.getElementById('lesson_lesson_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'lesson_lesson_file_list');
            }
        });
        document.getElementById('lesson_jokbo_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'lesson_jokbo_file_list');
            }
        });
        document.getElementById('partial_jokbo_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'partial_jokbo_file_list');
            }
        });
        document.getElementById('partial_lesson_file_list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('file-remove')) {
                removeFileFromBucket(e.target.dataset.bucket, parseInt(e.target.dataset.index, 10), 'partial_lesson_file_list');
            }
        });
        
        // Preflight cache keyed by mode
        const LATEST_PREFLIGHT = { 'jokbo-centric': null, 'lesson-centric': null, 'partial-jokbo': null };
        function currentOptions(mode) {
            const multiApi = getMultiApiState(mode);
            let minRel = 70;
            if (mode === 'jokbo-centric') {
                const n = parseInt(String(document.getElementById('jokbo_min_rel').value), 10);
                minRel = isNaN(n) ? 70 : Math.max(0, Math.min(n, 110));
            } else if (mode === 'lesson-centric') {
                const n = parseInt(String(document.getElementById('lesson_min_rel').value), 10);
                minRel = isNaN(n) ? 70 : Math.max(0, Math.min(n, 110));
            }
            return { multiApi, minRel };
        }
        function buildFormDataFromStaged(jokboInputId, lessonInputId, opts) {
            const fd = new FormData();
            const jokboFiles = stagedFiles[jokboInputId] || [];
            const lessonFiles = stagedFiles[lessonInputId] || [];
            for (const f of jokboFiles) fd.append('jokbo_files', f);
            for (const f of lessonFiles) fd.append('lesson_files', f);
            fd.append('multi_api', opts.multiApi ? 'true' : 'false');
            fd.append('min_relevance', String(opts.minRel));
            return fd;
        }
        function filesFingerprint(jokboInputId, lessonInputId, model, opts) {
            const jb = (stagedFiles[jokboInputId] || []).map(f => `${f.name}:${f.size}:${f.lastModified}`).join('|');
            const ls = (stagedFiles[lessonInputId] || []).map(f => `${f.name}:${f.size}:${f.lastModified}`).join('|');
            return `${model}|${opts.multiApi?'m':'s'}|${opts.minRel}|${jb}||${ls}`;
        }
        async function doPreflight(mode, jokboInputId, lessonInputId, model) {
            const opts = currentOptions(mode);
            const fd = buildFormDataFromStaged(jokboInputId, lessonInputId, opts);
            const url = `/preflight/${mode}?model=${encodeURIComponent(model)}`;
            const res = await fetch(url, { method: 'POST', credentials: 'include', body: fd });
            if (!res.ok) {
                let msg = 'Preflight failed';
                try { const e = await res.json(); msg = e.detail || msg; } catch {}
                throw new Error(msg);
            }
            const data = await res.json();
            // Cache per mode with fingerprint
            LATEST_PREFLIGHT[mode] = { data, fingerprint: filesFingerprint(jokboInputId, lessonInputId, model, opts) };
            // Update estimate UI
            try { updateEstimate(mode, data); } catch {}
            return data;
        }
        function updateEstimate(mode, pf) {
            const elId = (mode === 'jokbo-centric')
              ? 'jokbo_estimate'
              : (mode === 'lesson-centric'
                 ? 'lesson_estimate'
                 : (mode === 'partial-jokbo' ? 'partial_estimate' : null));
            if (!elId) return;
            const el = document.getElementById(elId);
            if (!el) return;
            const jbCnt = (pf && pf.files && pf.files.jokbo) ? pf.files.jokbo.length : 0;
            const lsCnt = (pf && pf.files && pf.files.lesson) ? pf.files.lesson.length : 0;
            const tc = pf.total_chunks || 0;
            const tpc = pf.tokens_per_chunk || 0;
            const et = pf.estimated_tokens || 0;
            el.innerHTML = tc > 0 ? `
              <div class="mt-2 p-2 bg-gray-900/60 border border-gray-800 rounded">
                <div>Files: ${jbCnt} exam · ${lsCnt} lecture</div>
                <div>Chunks: <strong>${tc}</strong> (approx.)</div>
                <div>Tokens: ~ <strong>${et}</strong> (${tpc} / chunk)</div>
              </div>` : '';
        }

        // Form submission
        async function submitAnalysis(mode, jokboInputId, lessonInputId, model) {
            const statusBadge = document.getElementById('status-badge');
            const statusContent = document.getElementById('status-content');
            const statusMessage = document.getElementById('status-message');
            
            // Validate files from staged buckets (supports multi-step add/remove)
            const jokboFiles = stagedFiles[jokboInputId] || [];
            const lessonFiles = stagedFiles[lessonInputId] || [];
            
            if (jokboFiles.length === 0 || lessonFiles.length === 0) {
                statusBadge.className = 'status-badge error';
                statusBadge.textContent = 'ERROR';
                statusMessage.textContent = 'Please select both exam and lecture files';
                return;
            }
            
            // Check file sizes
            for (let file of [...jokboFiles, ...lessonFiles]) {
                if (file.size > MAX_FILE_SIZE) {
                    statusBadge.className = 'status-badge error';
                    statusBadge.textContent = 'ERROR';
                    statusMessage.textContent = 'Please remove files larger than 50MB';
                    return;
                }
            }
            // Require sign-in before uploading
            if (!CURRENT_USER) {
                statusBadge.className = 'status-badge error';
                statusBadge.textContent = 'AUTH REQUIRED';
                statusContent.innerHTML = '<div class="status-message">Please sign in with Google to use the service.</div>';
                return;
            }
            
            try {
                // Unified preflight + confirm + start flow for all modes
                statusBadge.className = 'status-badge processing';
                statusBadge.textContent = 'UPLOADING';
                statusContent.innerHTML = `
                    <div>
                        <div class="loader"></div>
                        <div class="status-message" style="margin-top: 1rem">Uploading for preflight...</div>
                        <div class="progress-wrapper">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>
                `;

                const pf = await doPreflight(mode, jokboInputId, lessonInputId, model);

                const tpc = pf.tokens_per_chunk || 0;
                const et = pf.estimated_tokens || 0;
                const tc = pf.total_chunks || 0;
                const proceed = window.confirm(`총 청크: ${tc}\n예상 토큰: ${et} (청크당 ${tpc})\n\n이대로 분석을 시작할까요?`);
                if (!proceed) {
                    statusBadge.className = 'status-badge idle';
                    statusBadge.textContent = 'IDLE';
                    statusContent.innerHTML = '<p id="status-message" class="text-gray-400">Ready to process your files.</p>';
                    return;
                }

                statusBadge.className = 'status-badge processing';
                statusBadge.textContent = 'PROCESSING';
                statusContent.innerHTML = `
                    <div>
                        <div class="loader"></div>
                        <div class="status-message" style="margin-top: 1rem">
                            ${getMultiApiState(mode) ? 'Multi-API' : 'Single API'} · ${model.toUpperCase()}<br>
                            <small class="text-gray-500">Job ID: ${pf.job_id}</small>
                        </div>
                        <div class="progress-wrapper">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                `;
                const startRes = await fetch(`/jobs/${pf.job_id}/start`, { method: 'POST', credentials: 'include' });
                if (!startRes.ok) {
                    let msg = 'Failed to start job';
                    try { const e = await startRes.json(); msg = e.detail || msg; } catch {}
                    throw new Error(msg);
                }
                const startData = await startRes.json();
                checkStatus(startData.task_id, startData.job_id);
            } catch (error) {
                statusBadge.className = 'status-badge error';
                statusBadge.textContent = 'ERROR';
                statusContent.innerHTML = `
                    <div class="status-message">
                        ❌ ${error.message}
                    </div>
                `;
            }
        }
        
        async function checkStatus(taskId, jobId) {
            const statusBadge = document.getElementById('status-badge');
            const statusContent = document.getElementById('status-content');
            let lastPct = -1;
            let lastUpdate = Date.now();
            const startedAt = Date.now();
            const interval = setInterval(async () => {
                try {
                    // Check progress first
                    try {
                        const progressRes = await fetch(`/progress/${jobId}`, { credentials: 'include' });
                        if (progressRes.ok) {
                            const progressData = await progressRes.json();
                            const chunks = progressData.total_chunks ? ` · ${progressData.completed_chunks||0}/${progressData.total_chunks} chunks` : '';
                            const etaSecs = (progressData.eta_seconds && progressData.eta_seconds > 0) ? Math.round(progressData.eta_seconds) : null;
                            const etaText = etaSecs ? ` · ETA ${new Date(etaSecs*1000).toISOString().substr(11,8)}` : '';
                            const pct = progressData.progress||0;
                            if (pct !== lastPct) {
                                lastPct = pct;
                                lastUpdate = Date.now();
                            }
                            statusContent.innerHTML = `
                                <div class="status-message">
                                    <div style="margin-bottom: 0.5rem;">${progressData.message || ''}</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${pct}%"></div>
                                    </div>
                                    <div style="margin-top: 0.25rem; font-size: 0.875rem; color: #666;">
                                        ${pct}% 완료${chunks}${etaText}
                                    </div>
                                    ${(() => {
                                        const minutesStuck = (Date.now() - lastUpdate) / 60000;
                                        const totalMinutes = (Date.now() - startedAt) / 60000;
                                        if (minutesStuck >= 8 || totalMinutes >= 20) {
                                            return `<div style="margin-top:.5rem;color:var(--gray-500);">진행이 지연되는 것 같나요? <button class="tab" onclick="cancelJob('${jobId}')">⏹️ 작업 취소</button></div>`;
                                        }
                                        return '';
                                    })()}
                                </div>
                            `;
                        }
                    } catch (e) {
                        // Progress endpoint might not be available yet
                    }
                    
                    const res = await fetch(`/status/${taskId}`, { credentials: 'include' });
                    const data = await res.json();
                    
                    if (data.status === 'SUCCESS') {
                        clearInterval(interval);
                        statusBadge.className = 'status-badge success';
                        statusBadge.textContent = 'COMPLETED';
                        
                        // Get list of files
                        const filesRes = await fetch(`/results/${jobId}`, { credentials: 'include' });
                        let downloadLinks = '';
                        
                        if (filesRes.ok) {
                            const filesData = await filesRes.json();
                            for (const filename of filesData.files) {
                                downloadLinks += `
                                    <a href="/result/${jobId}/${filename}" class="download-btn" target="_blank">
                                        <span>📥</span>
                                        <span>Download ${filename}</span>
                                    </a>
                                `;
                            }
                        } else {
                            downloadLinks = `
                                <a href="/result/${jobId}" class="download-btn" target="_blank">
                                    <span>📥</span>
                                    <span>Download Result</span>
                                </a>
                            `;
                        }
                        // Optional warnings summary from backend
                        const warningsHtml = (() => {
                          try {
                            const resMeta = (data && data.result) ? data.result : null;
                            const warn = resMeta && resMeta.warnings ? resMeta.warnings : null;
                            if (!warn) return '';
                            const parts = [];
                            if (Array.isArray(warn.failed_files) && warn.failed_files.length) {
                              parts.push(`<div>⚠ 일부 파일 처리 실패: ${warn.failed_files.map(x => `<code>${x}</code>`).join(', ')}</div>`);
                            }
                            if (warn.failed_chunks && warn.failed_chunks > 0) {
                              parts.push(`<div>⚠ 일부 페이지 청크 처리 실패: ${warn.failed_chunks}개</div>`);
                            }
                            if (warn.partial === true) {
                              parts.push(`<div><em>완전한 분석이 아닙니다. 실패한 항목을 제외하고 결과를 생성했습니다.</em></div>`);
                            }
                            return parts.length ? `<div style="margin:.75rem 0; padding:.75rem; border:1px dashed var(--glass-border); background: rgba(255,255,255,0.5)">${parts.join('')}</div>` : '';
                          } catch { return ''; }
                        })();

                        statusContent.innerHTML = `
                            <div>
                                <div class="status-message">
                                    ✅ Analysis completed successfully!<br>
                            <small class="text-gray-500">Job ID: ${jobId}</small>
                                </div>
                                ${warningsHtml}
                                ${downloadLinks}
                            </div>
                        `;
                        
                    } else if (data.status === 'FAILURE') {
                        clearInterval(interval);
                        statusBadge.className = 'status-badge error';
                        statusBadge.textContent = 'FAILED';
                        let extra = '';
                        try {
                          const pr = await fetch(`/progress/${jobId}`, { credentials: 'include' });
                          if (pr.ok) {
                            const pj = await pr.json();
                            const msg = (pj && pj.message) || '';
                            if (msg.includes('토큰 잔액 부족')) {
                              extra = `<div style="margin-top:.5rem;color:#b44;">Insufficient tokens. Please contact admin for a top-up.</div>`;
                            }
                          }
                        } catch {}
                        statusContent.innerHTML = `
                            <div class="status-message">
                                ❌ Analysis failed: ${data.error || 'Unknown error'}
                                ${extra}
                            </div>
                        `;
                    }
                } catch (error) {
                    clearInterval(interval);
                    statusBadge.className = 'status-badge error';
                    statusBadge.textContent = 'ERROR';
                    statusContent.innerHTML = `
                        <div class="status-message">
                            ❌ Connection error: ${error.message}
                        </div>
                    `;
                }
            }, 1200);
        }
        
        // Form handlers
        document.getElementById('jokboForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const model = document.getElementById('jokbo_model').value;
            await submitAnalysis('jokbo-centric', 'jokbo_files', 'jokbo_lesson_files', model);
        });
        
        document.getElementById('lessonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const model = document.getElementById('lesson_model').value;
            await submitAnalysis('lesson-centric', 'lesson_jokbo_files', 'lesson_lesson_files', model);
        });

        // Trigger automatic preflight estimate when both buckets filled or options change
        async function maybePreflight(mode, jokboId, lessonId, model) {
            const jb = stagedFiles[jokboId] || [];
            const ls = stagedFiles[lessonId] || [];
            if (!CURRENT_USER) return; // require login to preflight (uses server)
            if (jb.length === 0 || ls.length === 0) return;
            const opts = currentOptions(mode);
            const fp = filesFingerprint(jokboId, lessonId, model, opts);
            const cached = LATEST_PREFLIGHT[mode];
            if (cached && cached.fingerprint === fp) {
                // Already up-to-date
                try { updateEstimate(mode, cached.data); } catch {}
                return;
            }
            try { await doPreflight(mode, jokboId, lessonId, model); } catch (e) { /* ignore */ }
        }
        // Wire preflight on file selection changes
        document.getElementById('jokbo_files').addEventListener('change', () => {
            const model = document.getElementById('jokbo_model').value;
            maybePreflight('jokbo-centric', 'jokbo_files', 'jokbo_lesson_files', model);
        });
        document.getElementById('jokbo_lesson_files').addEventListener('change', () => {
            const model = document.getElementById('jokbo_model').value;
            maybePreflight('jokbo-centric', 'jokbo_files', 'jokbo_lesson_files', model);
        });
        document.getElementById('lesson_lesson_files').addEventListener('change', () => {
            const model = document.getElementById('lesson_model').value;
            maybePreflight('lesson-centric', 'lesson_jokbo_files', 'lesson_lesson_files', model);
        });
        document.getElementById('lesson_jokbo_files').addEventListener('change', () => {
            const model = document.getElementById('lesson_model').value;
            maybePreflight('lesson-centric', 'lesson_jokbo_files', 'lesson_lesson_files', model);
        });
        document.getElementById('partial_jokbo_files').addEventListener('change', () => {
            const model = document.getElementById('partial_model').value;
            maybePreflight('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
        });
        document.getElementById('partial_lesson_files').addEventListener('change', () => {
            const model = document.getElementById('partial_model').value;
            maybePreflight('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
        });
        // Wire preflight when options change (model / min relevance / multi-api)
        document.getElementById('jokbo_model').addEventListener('change', () => {
            const model = document.getElementById('jokbo_model').value;
            maybePreflight('jokbo-centric', 'jokbo_files', 'jokbo_lesson_files', model);
        });
        document.getElementById('lesson_model').addEventListener('change', () => {
            const model = document.getElementById('lesson_model').value;
            maybePreflight('lesson-centric', 'lesson_jokbo_files', 'lesson_lesson_files', model);
        });
        document.getElementById('partial_model').addEventListener('change', () => {
            const model = document.getElementById('partial_model').value;
            maybePreflight('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
        });
        document.getElementById('partial_min_rel').addEventListener('input', () => {
            const model = document.getElementById('partial_model').value;
            maybePreflight('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
        });

        document.getElementById('partialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const model = document.getElementById('partial_model').value;
            await submitAnalysis('partial-jokbo', 'partial_jokbo_files', 'partial_lesson_files', model);
        });

        // Admin cleanup: POST /admin/cleanup with optional older-than filter
        function getAdminPassword() {
            const saved = localStorage.getItem('jd_admin_password') || '';
            const input = document.getElementById('admin_password');
            if (input && input.value) return input.value;
            return saved;
        }
        async function adminCleanup(olderHours = null) {
            try {
                const params = new URLSearchParams();
                if (!CURRENT_USER || !CURRENT_USER.admin) {
                    const pw = getAdminPassword();
                    if (!pw) { alert('Enter Admin Password in the Admin Tools section first.'); return; }
                    params.set('password', pw);
                }
                params.set('clear_cache', 'true');
                params.set('clear_debug', 'true');
                params.set('clear_temp_sessions', 'true');
                if (olderHours && olderHours > 0) params.set('older_than_hours', String(olderHours));
                const res = await fetch(`/admin/cleanup?${params.toString()}`, { method: 'POST', credentials: 'include' });
                if (!res.ok) throw new Error('Cleanup request failed');
                const data = await res.json();
                const out = document.getElementById('admin_output');
                if (out) out.textContent = JSON.stringify(data, null, 2);
                else alert('Cleanup done.');
            } catch (e) {
                const out = document.getElementById('admin_output');
                if (out) out.textContent = 'Cleanup error: ' + e.message;
                else alert('Cleanup error: ' + e.message);
            }
        }
        document.getElementById('clear_cache_btn').addEventListener('click', (e) => {
            e.preventDefault();
            const older = prompt('Delete only files older than N hours? (Leave empty for all)', '');
            const n = older ? parseInt(older, 10) : null;
            adminCleanup(isNaN(n) ? null : n);
        });

        // Admin tools wiring
        const adminPwSaved = localStorage.getItem('jd_admin_password') || '';
        if (adminPwSaved) {
            const input = document.getElementById('admin_password');
            if (input) input.value = adminPwSaved;
        }
        document.getElementById('save_admin_pw_btn').addEventListener('click', () => {
            const v = (document.getElementById('admin_password').value || '').trim();
            if (!v) { alert('Enter a password to save.'); return; }
            localStorage.setItem('jd_admin_password', v);
            alert('Saved admin password locally for this browser.');
        });
        document.getElementById('run_cleanup_btn').addEventListener('click', () => {
            const older = document.getElementById('older_hours').value;
            const n = older ? parseInt(older, 10) : null;
            adminCleanup(isNaN(n) ? null : n);
        });
        document.getElementById('prune_24h_btn').addEventListener('click', async () => {
            const out = document.getElementById('admin_output');
            try {
                const params = new URLSearchParams();
                if (!CURRENT_USER || !CURRENT_USER.admin) {
                    const pw = getAdminPassword();
                    if (!pw) { alert('Enter Admin Password first.'); return; }
                    params.set('password', pw);
                }
                params.set('older_than_hours', '24');
                params.set('clear_results', 'true');
                params.set('clear_storage', 'true');
                const res = await fetch(`/admin/cleanup?${params.toString()}`, { method: 'POST', credentials: 'include' });
                if (!res.ok) throw new Error('Prune request failed');
                const data = await res.json();
                out.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                out.textContent = 'Prune error: ' + e.message;
            }
        });
        document.getElementById('show_stats_btn').addEventListener('click', async () => {
            const out = document.getElementById('admin_output');
            try {
                let url = '/admin/storage-stats';
                if (!CURRENT_USER || !CURRENT_USER.admin) {
                    const pw = getAdminPassword();
                    if (!pw) { alert('Enter Admin Password first.'); return; }
                    url += `?password=${encodeURIComponent(pw)}`;
                }
                const res = await fetch(url, { credentials: 'include' });
                if (!res.ok) throw new Error('Stats request failed');
                const data = await res.json();
                out.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                out.textContent = 'Stats error: ' + e.message;
            }
        });

        // Auth + config init
        let AUTH_CONFIG = { enabled: false, client_id: '', allow_dev_login: false, feedback_form_url: '' };
        let CURRENT_USER = null;
        async function fetchAuthConfig() {
            try {
                const r = await fetch('/auth/config', { credentials: 'include' });
                if (r.ok) AUTH_CONFIG = await r.json();
                const f = document.getElementById('feedback_link');
                if (AUTH_CONFIG.feedback_form_url) {
                    f.href = AUTH_CONFIG.feedback_form_url;
                    f.style.display = 'inline-block';
                }
                // Show token info line if enabled
                try {
                    const t = document.getElementById('token_info_line');
                    if (t && AUTH_CONFIG.tokens_enabled) {
                        const flash = (AUTH_CONFIG.token_costs && AUTH_CONFIG.token_costs.flash) || 1;
                        const pro = (AUTH_CONFIG.token_costs && AUTH_CONFIG.token_costs.pro) || 4;
                        t.textContent = `Token costs · Flash: ${flash}/chunk · Pro: ${pro}/chunk`;
                        t.style.display = 'block';
                    }
                } catch {}
                try { setupGoogleSignIn(); } catch {}
            } catch {}
        }
        // Google Sign-In helpers
        async function onCredential(resp) {
            try {
                const r = await fetch('/auth/google', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ id_token: resp.credential })
                });
                if (!r.ok) {
                    let msg = 'Sign-in failed';
                    try { const j = await r.json(); if (j && j.detail) msg = j.detail; } catch {}
                    throw new Error(msg);
                }
                await refreshAuthUI();
            } catch (e) {
                alert('Login error: ' + (e && e.message ? e.message : e));
            }
        }
        function setupGoogleSignIn() {
            if (!AUTH_CONFIG.client_id) return;
            try {
                /* global google */
                google.accounts.id.initialize({
                    client_id: AUTH_CONFIG.client_id,
                    callback: onCredential,
                    itp_support: true,
                    ux_mode: 'popup',
                    auto_select: false
                });
                const btn = document.getElementById('gsi_btn');
                if (btn && btn.childElementCount === 0) {
                    google.accounts.id.renderButton(btn, {
                        type: 'standard', size: 'large', theme: 'outline',
                        text: 'signin_with', shape: 'pill', logo_alignment: 'left'
                    });
                }
            } catch (e) {
                // Ignore if script not ready
            }
        }
        async function refreshAuthUI() {
            try {
                const res = await fetch('/me', { credentials: 'include' });
                const info = res.ok ? await res.json() : { authenticated: false };
                CURRENT_USER = info && info.authenticated ? info : null;
            } catch { CURRENT_USER = null; }
            const userBadge = document.getElementById('user_badge');
            const tokenBadge = document.getElementById('token_badge');
            const loginBtn = document.getElementById('login_btn');
            const logoutBtn = document.getElementById('logout_btn');
            const myJobsLink = document.getElementById('my_jobs_link');
            const clearBtn = document.getElementById('clear_cache_btn');
            const adminSections = document.getElementById('admin_sections');
            if (CURRENT_USER) {
                userBadge.textContent = CURRENT_USER.email || CURRENT_USER.name || 'Signed in';
                userBadge.style.display = 'inline-block';
                tokenBadge.textContent = `Tokens: ${CURRENT_USER.tokens ?? '-'}`;
                tokenBadge.style.display = 'inline-block';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                if (myJobsLink) myJobsLink.style.display = 'inline-block';
                if (CURRENT_USER.admin) {
                    clearBtn.style.display = 'inline-block';
                    adminSections.style.display = 'block';
                    try { loadTesters(); } catch {}
                    try { fetchUsers(null); } catch {}
                } else {
                    clearBtn.style.display = 'none';
                    adminSections.style.display = 'none';
                }
            } else {
                userBadge.style.display = 'none';
                tokenBadge.style.display = 'none';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                if (myJobsLink) myJobsLink.style.display = 'none';
                clearBtn.style.display = 'none';
                adminSections.style.display = 'none';
            }
        }
        document.getElementById('login_btn').addEventListener('click', async () => {
            if (AUTH_CONFIG.client_id) {
                try {
                    setupGoogleSignIn();
                    /* global google */
                    google.accounts.id.prompt((notification) => {
                        const notShown = (typeof notification.isNotDisplayed === 'function' && notification.isNotDisplayed()) ||
                                         (typeof notification.isSkippedMoment === 'function' && notification.isSkippedMoment());
                        if (notShown) {
                            const btn = document.getElementById('gsi_btn');
                            if (btn) btn.style.display = 'inline-block';
                        }
                    });
                } catch (e) {
                    const btn = document.getElementById('gsi_btn');
                    if (btn) btn.style.display = 'inline-block';
                }
            } else if (AUTH_CONFIG.allow_dev_login) {
                const email = prompt('Dev login email:');
                if (!email) return;
                const pw = prompt('Admin password for dev login:');
                if (!pw) return;
                try {
                    const r = await fetch('/auth/dev-login', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ email, password: pw }) });
                    if (!r.ok) throw new Error('Dev login failed');
                    await refreshAuthUI();
                } catch (e) { alert('Dev login error: ' + e.message); }
            } else {
                alert('Sign-in not configured. Please set GOOGLE_OAUTH_CLIENT_ID or enable dev login.');
            }
        });
        document.getElementById('logout_btn').addEventListener('click', async () => {
            try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch {}
            await refreshAuthUI();
        });

        // --- Admin: testers management ---
        async function loadTesters() {
            const box = document.getElementById('testers_list');
            if (!box) return;
            box.textContent = 'Loading...';
            try {
                const res = await fetch('/admin/testers', { credentials: 'include' });
                if (!res.ok) throw new Error('Forbidden or failed');
                const data = await res.json();
                const list = data.dynamic || [];
                if (!list.length) { box.innerHTML = '<div class="status-message">No testers yet. Add emails above.</div>'; return; }
                let html = '';
                for (const e of list) {
                    const esc = encodeURIComponent(e);
                    html += `<div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding:.4rem 0;">`+
                            `<span>${e}</span>`+
                            `<button class="tab" style="padding:.3rem .6rem;" onclick="removeTester('${esc}')">Remove</button>`+
                            `</div>`;
                }
                box.innerHTML = html;
            } catch (e) {
                box.textContent = 'Failed to load testers: ' + e.message;
            }
        }
        async function addTester(email) {
            const box = document.getElementById('testers_list');
            try {
                const res = await fetch('/admin/testers', { method:'POST', credentials: 'include', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({ email }) });
                if (!res.ok) throw new Error('Add failed');
                await loadTesters();
            } catch (e) { box.textContent = 'Add tester error: ' + e.message; }
        }
        async function removeTester(email) {
            const box = document.getElementById('testers_list');
            try {
                const res = await fetch('/admin/testers/' + email, { method:'DELETE', credentials: 'include' });
                if (!res.ok) throw new Error('Delete failed');
                await loadTesters();
            } catch (e) { box.textContent = 'Remove tester error: ' + e.message; }
        }
        window.removeTester = removeTester; // expose for onclick
        const addTesterBtn = document.getElementById('add_tester_btn');
        if (addTesterBtn) {
            addTesterBtn.addEventListener('click', () => {
                const v = (document.getElementById('tester_email').value || '').trim();
                if (!v) { alert('Enter email'); return; }
                addTester(v);
            });
        }
        const reloadTestersBtn = document.getElementById('reload_testers_btn');
        if (reloadTestersBtn) reloadTestersBtn.addEventListener('click', loadTesters);

        // --- Admin: users list + tokens ---
        async function renderUsers(list) {
            const el = document.getElementById('users_list');
            if (!el) return;
            if (!list || !list.length) { el.innerHTML = '<div class="status-message">No users.</div>'; return; }
            let html = '';
            for (const u of list) {
                const uid = u.user_id || '';
                const email = u.email || '';
                const name = u.name || '';
                const tokens = (u.tokens ?? '-')
                const escUid = encodeURIComponent(uid);
                html += `<div style="padding:.5rem 0;border-bottom:1px solid var(--border);">`+
                        `<div style=\"display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;\">`+
                        `<b>${email}</b> <span style=\"color:var(--muted)\">(${uid})</span> · <span>Tokens: ${tokens}</span>`+
                        `</div>`+
                        `<div style=\"display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-top:.4rem;\">`+
                        `<input type=\"number\" id=\"set_${escUid}\" placeholder=\"Set amount\" style=\"width:140px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:8px;\"/>`+
                        `<button class=\"tab\" onclick=\"setTokens('${escUid}')\">Set</button>`+
                        `<input type=\"number\" id=\"add_${escUid}\" placeholder=\"Add delta\" style=\"width:140px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:8px;\"/>`+
                        `<button class=\"tab\" onclick=\"addTokens('${escUid}')\">Add</button>`+
                        `</div>`+
                        `</div>`;
            }
            el.innerHTML = html;
        }
        async function fetchUsers(queryEmail = null) {
            const el = document.getElementById('users_list');
            if (!el) return;
            el.textContent = 'Loading...';
            try {
                let url = '/admin/users';
                if (queryEmail) url += `?q=${encodeURIComponent(queryEmail)}`;
                const res = await fetch(url, { credentials: 'include' });
                if (!res.ok) throw new Error('Forbidden or failed');
                const data = await res.json();
                await renderUsers(data.users || []);
            } catch (e) { el.textContent = 'Load users error: ' + e.message; }
        }
        async function setTokens(userId) {
            const input = document.getElementById('set_' + userId);
            const val = parseInt((input && input.value) || '', 10);
            if (isNaN(val)) { alert('Enter a number'); return; }
            try {
                const res = await fetch(`/admin/users/${userId}/tokens?amount=${val}`, { method:'POST', credentials: 'include' });
                if (!res.ok) throw new Error('Set failed');
                const email = document.getElementById('user_search_email').value || '';
                await fetchUsers(email || null);
            } catch (e) { alert('Set tokens error: ' + e.message); }
        }
        async function addTokens(userId) {
            const input = document.getElementById('add_' + userId);
            const val = parseInt((input && input.value) || '', 10);
            if (isNaN(val)) { alert('Enter a number'); return; }
            try {
                const res = await fetch(`/admin/users/${userId}/tokens/add?delta=${val}`, { method:'POST', credentials: 'include' });
                if (!res.ok) throw new Error('Add failed');
                const email = document.getElementById('user_search_email').value || '';
                await fetchUsers(email || null);
            } catch (e) { alert('Add tokens error: ' + e.message); }
        }
        window.setTokens = setTokens; window.addTokens = addTokens;
        const searchUsersBtn = document.getElementById('search_users_btn');
        if (searchUsersBtn) searchUsersBtn.addEventListener('click', () => {
            const v = (document.getElementById('user_search_email').value || '').trim();
            if (!v) { alert('Enter email'); return; }
            fetchUsers(v);
        });
        const listUsersBtn = document.getElementById('list_users_btn');
        if (listUsersBtn) listUsersBtn.addEventListener('click', () => fetchUsers(null));

        // Load My Jobs
        document.getElementById('load_jobs_btn').addEventListener('click', async () => {
            const list = document.getElementById('jobs_list');
            if (!CURRENT_USER || !CURRENT_USER.user_id) {
                list.innerHTML = '<div class="status-message">Please sign in to view your jobs.</div>';
                return;
            }
            list.innerHTML = '<div class="status-message">Loading...</div>';
            try {
                const res = await fetch(`/user/${encodeURIComponent(CURRENT_USER.user_id)}/jobs`, { credentials: 'include' });
                const data = await res.json();
                if (!data.jobs || data.jobs.length === 0) {
                    list.innerHTML = '<div class="status-message">No jobs found.</div>';
                    return;
                }
                let html = '';
                for (const j of data.jobs) {
                    const prog = j.progress || {};
                    const pct = prog.progress || 0;
                    const chunks = (prog.total_chunks ? `${prog.completed_chunks||0}/${prog.total_chunks} chunks` : '');
                    let files = '';
                    for (const f of (j.files||[])) {
                        const ef = encodeURIComponent(f);
                        files += `<div style="display:flex;gap:0.4rem;align-items:center;">`+
                                 `<a class="download-btn" style="margin-top:0.5rem;" href="/result/${j.job_id}/${ef}" target="_blank">📥 ${f}</a>`+
                                 `<button style="margin-top:0.5rem;padding:0.4rem 0.6rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="deleteResult('${j.job_id}','${ef}')">🗑️ Delete</button>`+
                                 `</div>`;
                    }
                    const canCancel = (j.status === 'PENDING' || j.status === 'STARTED' || j.status === 'RETRY');
                    html += `
                        <div style="padding:1rem;border-bottom:1px solid var(--border);">
                            <div class="status-message" style="text-align:left;">
                                <div><b>Job:</b> ${j.job_id} · <b>Status:</b> ${j.status}</div>
                                <div class="progress-bar" style="margin:0.4rem 0;">
                                    <div class="progress-fill" style="width:${pct}%"></div>
                                </div>
                                <div style="font-size:0.875rem;color:#666;">${pct}% ${chunks}</div>
                                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;">${files}</div>
                                <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
                                    ${canCancel ? `<button style="padding:0.5rem 0.8rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="cancelJob('${j.job_id}')">⏹️ Cancel</button>` : ''}
                                    <button style="padding:0.5rem 0.8rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="deleteJob('${j.job_id}')">🧹 Delete Job</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = `<div class="status-message">Failed to load jobs: ${e.message}</div>`;
            }
        });
        async function cancelJob(jobId) {
            try {
                await fetch(`/jobs/${jobId}/cancel`, { method: 'POST', credentials: 'include' });
                document.getElementById('load_jobs_btn').click();
            } catch (e) {
                alert('Failed to cancel: ' + e.message);
            }
        }
        async function deleteJob(jobId) {
            if (!confirm('Delete this job and its results?')) return;
            try {
                await fetch(`/jobs/${jobId}`, { method: 'DELETE', credentials: 'include' });
                document.getElementById('load_jobs_btn').click();
            } catch (e) {
                alert('Failed to delete: ' + e.message);
            }
        }
        async function deleteResult(jobId, filename) {
            if (!confirm('Delete this result file?')) return;
            try {
                await fetch(`/result/${jobId}/${filename}`, { method: 'DELETE', credentials: 'include' });
                document.getElementById('load_jobs_btn').click();
            } catch (e) {
                alert('Failed to delete file: ' + e.message);
            }
        }

        // Helpers: help panel toggles and range outputs
        function initHelpToggles() {
            const updateOpenHeights = () => {
                document.querySelectorAll('.help-panel.show').forEach(p => {
                    // Set max-height to content height for smooth expand/collapse
                    p.style.maxHeight = p.scrollHeight + 'px';
                });
            };
            document.querySelectorAll('[data-help-target]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-help-target');
                    const el = document.getElementById(id);
                    if (!el) return;
                    const isOpen = el.classList.contains('show');
                    if (isOpen) {
                        // Collapse
                        el.style.maxHeight = '0px';
                        el.classList.remove('show');
                        btn.setAttribute('aria-expanded', 'false');
                    } else {
                        // Expand
                        el.classList.add('show');
                        el.style.maxHeight = el.scrollHeight + 'px';
                        btn.setAttribute('aria-expanded', 'true');
                    }
                });
            });
            window.addEventListener('resize', () => {
                // Recompute heights for open panels on resize
                updateOpenHeights();
            });
            // Initialize heights for any pre-opened panels
            updateOpenHeights();
        }
        function bindRange(id, outId) {
            const r = document.getElementById(id);
            const o = document.getElementById(outId);
            if (!r || !o) return;
            const fmt = v => String(parseInt(v, 10));
            o.textContent = fmt(r.value);
            r.addEventListener('input', () => o.textContent = fmt(r.value));
        }

        // Initial boot
        (async () => {
            try { await fetchAuthConfig(); } catch {}
            try { await initConfigAndToggles(); } catch {}
            try { await refreshAuthUI(); } catch {}
            try { initHelpToggles(); } catch {}
            bindRange('jokbo_min_rel','jokbo_min_rel_out');
            bindRange('lesson_min_rel','lesson_min_rel_out');
            bindRange('partial_min_rel','partial_min_rel_out');
        })();
    </script>
</body>
</html>
