<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Jobs · JokboDude</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="/styles.css?v=5">
  <style>
    .aurora-background { position: fixed; inset: 0; pointer-events: none; z-index: -1; background: radial-gradient(circle at 10% 20%, rgba(58,122,255,.10), transparent 40%), radial-gradient(circle at 90% 80%, rgba(110,86,255,.10), transparent 40%), radial-gradient(circle at 50% 50%, rgba(30,190,255,.08), transparent 50%); filter: blur(80px); }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
    .muted { color: var(--muted); }
  </style>
  </head>
<body>
  <div class="aurora-background"></div>
  <nav class="sticky top-0 z-50 bg-black/30 backdrop-blur-lg border-b border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="/" class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-800 border border-gray-700 rounded-lg flex items-center justify-center text-xl">🎓</div>
          <span class="text-white text-2xl font-bold">JokboDude</span>
        </a>
        <div class="flex items-center gap-2 md:gap-4">
          <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" id="my_jobs_link" href="/profile" style="display:none;">My Jobs</a>
          <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" href="/guide">Guide</a>
          <a class="text-gray-400 hover:bg-gray-800 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" id="feedback_link" href="#" style="display:none;">Feedback</a>
          <div id="auth_area" class="flex items-center gap-2">
            <span id="user_badge" style="display:none;" class="px-3 py-1.5 border border-gray-700 rounded-full bg-gray-800/50 text-xs text-gray-300"></span>
            <span id="token_badge" style="display:none;" class="px-3 py-1.5 border border-gray-700 rounded-full bg-gray-800/50 text-xs text-gray-300">Tokens: -</span>
            <button id="login_btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg" style="display:none;">Sign in</button>
            <div id="gsi_btn" style="display:none;"></div>
            <button id="logout_btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-colors" style="display:none;">Logout</button>
            <button id="clear_cache_btn" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold text-sm py-2 px-4 rounded-lg transition-colors" style="display:none;" title="Clear cache and debug files">Clear Cache</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="header">
      <div>
        <h1 style="margin:0;">My Jobs</h1>
        <div class="muted" id="token_info" style="margin-top:.25rem;">&nbsp;</div>
      </div>
    </div>

    <div class="glass-card">
      <div class="p-6 border-b border-gray-800">
        <h2 class="text-xl font-bold text-white" id="user_title">Loading…</h2>
        <p class="text-gray-400" id="user_desc">&nbsp;</p>
      </div>
      <div class="p-6">
        <div style="display:flex; gap:.5rem; align-items:center; margin-bottom: .5rem;">
          <button id="refresh_jobs_btn" class="tab">Refresh</button>
        </div>
        <div id="jobs_list" class="bg-gray-900/70 border border-gray-800 rounded-lg p-4 min-h-[80px]" style="display:block;align-items:stretch;justify-content:flex-start;"></div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin_panel" class="glass-card" style="display:none; margin-top:1.25rem;">
      <div class="p-6 border-b border-gray-800">
        <h2 class="text-xl font-bold text-white">Admin · Storage & Results</h2>
        <p class="text-gray-400">Storage Usage, Results Index, and Bulk Delete (admin only)</p>
      </div>
      <div class="p-6" style="display:flex; flex-direction:column; gap:1.25rem;">
        <!-- Storage Usage -->
        <section>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem; margin-bottom:0.5rem;">
            <h3 style="margin:0;">Storage Usage</h3>
            <button id="btn_storage_stats" class="tab">Refresh Stats</button>
          </div>
          <div id="storage_stats" class="bg-gray-900/70 border border-gray-800 rounded-lg p-4" style="min-height:60px;">
            <div class="text-gray-500">No data yet.</div>
          </div>
        </section>

        <!-- Results Index & Filters -->
        <section>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem; margin-bottom:0.5rem;">
            <h3 style="margin:0;">Results Index</h3>
            <div style="display:flex; gap:0.5rem; align-items:center;">
              <button id="btn_results_prev" class="tab" title="Prev">Prev</button>
              <button id="btn_results_next" class="tab" title="Next">Next</button>
              <button id="btn_results_load" class="tab">Load Index</button>
            </div>
          </div>
          <div class="bg-gray-900/40 border border-gray-800 rounded-lg p-3" style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
            <div>
              <label class="text-xs text-gray-400">User ID</label>
              <input id="filter_user_id" class="input" placeholder="partial user_id" />
            </div>
            <div>
              <label class="text-xs text-gray-400">User Email</label>
              <input id="filter_user_email" class="input" placeholder="partial email" />
            </div>
            <div>
              <label class="text-xs text-gray-400">Filename Contains</label>
              <input id="filter_filename" class="input" placeholder="substring" />
            </div>
            <div>
              <label class="text-xs text-gray-400">Older Than (h)</label>
              <input id="filter_older" type="number" class="input" value="48" min="0" />
            </div>
            <div>
              <label class="text-xs text-gray-400">Limit</label>
              <input id="filter_limit" type="number" class="input" value="50" min="1" max="1000" />
            </div>
            <div>
              <label class="text-xs text-gray-400">Offset</label>
              <input id="filter_offset" type="number" class="input" value="0" min="0" />
            </div>
          </div>
          <div id="results_index_list" class="bg-gray-900/70 border border-gray-800 rounded-lg p-4" style="min-height:80px; margin-top:0.5rem;"></div>
        </section>

        <!-- Bulk Delete -->
        <section>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:0.5rem; margin-bottom:0.5rem;">
            <h3 style="margin:0;">Bulk Delete</h3>
            <div style="display:flex; gap:0.5rem;">
              <button id="btn_dry_run" class="tab" title="Preview deletions">Dry Run</button>
              <button id="btn_bulk_delete" class="tab" style="background:#7f1d1d;border-color:#7f1d1d;">Delete Matched</button>
            </div>
          </div>
          <div id="bulk_delete_out" class="bg-gray-900/70 border border-gray-800 rounded-lg p-4" style="min-height:60px;">
            <div class="text-gray-500">Use the filters above. Default older_than_hours=48.</div>
          </div>
          <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
            <input id="prune_hours" type="number" class="input" value="48" min="0" style="width:140px;" />
            <button id="btn_prune_now" class="tab" title="Prune old results on disk">Prune Results Now</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    let AUTH_CONFIG = { tokens_enabled: true, token_costs: { flash: 1, pro: 4 } };
    async function fetchAuthConfig() {
      try {
        const r = await fetch('/auth/config', { credentials: 'include' });
        if (r.ok) AUTH_CONFIG = await r.json();
        try { setupGoogleSignIn(); } catch {}
      } catch {}
    }

    // Google Sign-In helpers
    async function onCredential(resp) {
      try {
        const r = await fetch('/auth/google', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ id_token: resp.credential })
        });
        if (!r.ok) {
          let msg = 'Sign-in failed';
          try { const j = await r.json(); if (j && j.detail) msg = j.detail; } catch {}
          throw new Error(msg);
        }
        location.reload();
      } catch (e) {
        alert('Login error: ' + (e && e.message ? e.message : e));
      }
    }
    function setupGoogleSignIn() {
      if (!AUTH_CONFIG.client_id) return;
      try {
        /* global google */
        google.accounts.id.initialize({
          client_id: AUTH_CONFIG.client_id,
          callback: onCredential,
          itp_support: true,
          ux_mode: 'popup',
          auto_select: false
        });
        const btn = document.getElementById('gsi_btn');
        if (btn && btn.childElementCount === 0) {
          google.accounts.id.renderButton(btn, {
            type: 'standard', size: 'large', theme: 'outline',
            text: 'signin_with', shape: 'pill', logo_alignment: 'left'
          });
        }
      } catch (e) { /* ignore */ }
    }

    async function ensureAuth() {
      try {
        const r = await fetch('/me', { credentials: 'include' });
        const me = r.ok ? await r.json() : { authenticated: false };
        const loginBtn = document.getElementById('login_btn');
        const logoutBtn = document.getElementById('logout_btn');
        if (!me.authenticated) {
          document.getElementById('user_title').textContent = 'Sign in required';
          document.getElementById('user_desc').textContent = 'Please sign in with Google to view your jobs.';
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
          return null;
        }
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        document.getElementById('user_title').textContent = me.email || me.name || 'My Jobs';
        const costs = (AUTH_CONFIG && AUTH_CONFIG.token_costs) || { flash: 1, pro: 4 };
        const tokenInfo = `Balance: ${me.tokens ?? '-'} · Costs — Flash: ${costs.flash}/chunk, Pro: ${costs.pro}/chunk`;
        document.getElementById('token_info').textContent = tokenInfo;
        return me;
      } catch {
        return null;
      }
    }

    async function loadJobs(userId) {
      const list = document.getElementById('jobs_list');
      list.innerHTML = '<div class="status-message">Loading...</div>';
      try {
        const res = await fetch(`/user/${encodeURIComponent(userId)}/jobs`, { credentials: 'include' });
        const data = await res.json();
        if (!data.jobs || data.jobs.length === 0) {
          list.innerHTML = '<div class="status-message">No jobs found.</div>';
          return;
        }
        let html = '';
        for (const j of data.jobs) {
          const prog = j.progress || {};
          const pct = prog.progress || 0;
          const chunks = (prog.total_chunks ? `${prog.completed_chunks||0}/${prog.total_chunks} chunks` : '');
          let files = '';
          for (const f of (j.files||[])) {
            const ef = encodeURIComponent(f);
            files += `<div style="display:flex;gap:0.4rem;align-items:center;">`
                   + `<a class="download-btn" style="margin-top:0.5rem;" href="/result/${j.job_id}/${ef}" target="_blank">📥 ${f}</a>`
                   + `<button style="margin-top:0.5rem;padding:0.4rem 0.6rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="deleteResult('${j.job_id}','${ef}')">🗑️ Delete</button>`
                   + `</div>`;
          }
          const canCancel = (j.status === 'PENDING' || j.status === 'STARTED' || j.status === 'RETRY');
          html += `
            <div style="padding:1rem;border-bottom:1px solid var(--border);">
              <div class="status-message" style="text-align:left;">
                <div><b>Job:</b> ${j.job_id} · <b>Status:</b> ${j.status}</div>
                <div class="progress-bar" style="margin:0.4rem 0;"><div class="progress-fill" style="width:${pct}%"></div></div>
                <div style="font-size:0.875rem;color:#666;">${pct}% ${chunks}</div>
                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;">${files}</div>
                <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
                  ${canCancel ? `<button style="padding:0.5rem 0.8rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="cancelJob('${j.job_id}')">⏹️ Cancel</button>` : ''}
                  <button style="padding:0.5rem 0.8rem;border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:6px;color:var(--muted);cursor:pointer;" onclick="deleteJob('${j.job_id}')">🧹 Delete Job</button>
                </div>
              </div>
            </div>`;
        }
        list.innerHTML = html;
      } catch (e) {
        list.innerHTML = `<div class="status-message">Failed to load jobs: ${e.message}</div>`;
      }
    }

    async function cancelJob(jobId) {
      try { await fetch(`/jobs/${jobId}/cancel`, { method: 'POST', credentials: 'include' }); await boot(); } catch (e) { alert('Failed to cancel: ' + e.message); }
    }
    async function deleteJob(jobId) {
      if (!confirm('Delete this job and its results?')) return;
      try { await fetch(`/jobs/${jobId}`, { method: 'DELETE', credentials: 'include' }); await boot(); } catch (e) { alert('Failed to delete: ' + e.message); }
    }
    async function deleteResult(jobId, filename) {
      if (!confirm('Delete this result file?')) return;
      try { await fetch(`/result/${jobId}/${filename}`, { method: 'DELETE', credentials: 'include' }); await boot(); } catch (e) { alert('Failed to delete file: ' + e.message); }
    }

    document.getElementById('logout_btn').addEventListener('click', async () => { try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch {} location.href='/' });
    document.getElementById('login_btn').addEventListener('click', async () => {
      try {
        if (!AUTH_CONFIG.client_id) { alert('Sign-in not configured.'); return; }
        setupGoogleSignIn();
        /* global google */
        google.accounts.id.prompt((notification) => {
          const notShown = (typeof notification.isNotDisplayed === 'function' && notification.isNotDisplayed()) ||
                           (typeof notification.isSkippedMoment === 'function' && notification.isSkippedMoment());
          if (notShown) {
            const btn = document.getElementById('gsi_btn');
            if (btn) btn.style.display = 'inline-block';
          }
        });
      } catch (e) {
        const btn = document.getElementById('gsi_btn');
        if (btn) btn.style.display = 'inline-block';
      }
    });

    document.getElementById('refresh_jobs_btn').addEventListener('click', async () => { await boot(); });

    async function boot() {
      await fetchAuthConfig();
      const me = await ensureAuth();
      if (me && me.user_id) await loadJobs(me.user_id);
      try { if (me && me.admin) { document.getElementById('admin_panel').style.display = 'block'; await adminLoadStats(); await adminLoadIndex(); } } catch {}
    }

    boot();

    // --- Admin helpers ---
    function getFilters() {
      return {
        user_id: document.getElementById('filter_user_id').value.trim() || undefined,
        user_email: document.getElementById('filter_user_email').value.trim() || undefined,
        filename_contains: document.getElementById('filter_filename').value.trim() || undefined,
        older_than_hours: parseInt(document.getElementById('filter_older').value || '0', 10),
        limit: parseInt(document.getElementById('filter_limit').value || '50', 10),
        offset: parseInt(document.getElementById('filter_offset').value || '0', 10)
      };
    }

    function setOffset(val) {
      const el = document.getElementById('filter_offset');
      el.value = String(Math.max(0, val|0));
    }

    async function adminLoadStats() {
      const box = document.getElementById('storage_stats');
      box.innerHTML = '<div class="text-gray-500">Loading…</div>';
      try {
        const r = await fetch('/admin/storage-stats', { credentials: 'include' });
        if (!r.ok) { if (r.status === 403) { document.getElementById('admin_panel').style.display='none'; } throw new Error('HTTP '+r.status); }
        const j = await r.json();
        const fmt = (n) => new Intl.NumberFormat().format(n||0);
        const mk = (k) => j[k] ? `<div><b>${k}</b>: files ${fmt(j[k].files)}, bytes ${fmt(j[k].bytes)} · <span class="text-gray-500">${j[k].path||''}</span></div>` : '';
        box.innerHTML = [mk('results'), mk('debug'), mk('sessions'), mk('tmp')].join('') + `<div class="text-gray-500" style="margin-top:.25rem;">${j.timestamp||''}</div>`;
      } catch (e) {
        box.innerHTML = `<div class="text-red-400">Failed to load: ${e.message}</div>`;
      }
    }

    async function adminLoadIndex() {
      const list = document.getElementById('results_index_list');
      list.innerHTML = '<div class="text-gray-500">Loading…</div>';
      const f = getFilters();
      const params = new URLSearchParams();
      if (f.user_id) params.set('user_id', f.user_id);
      if (f.user_email) params.set('user_email', f.user_email);
      if (f.filename_contains) params.set('filename_contains', f.filename_contains);
      if (!isNaN(f.older_than_hours)) params.set('older_than_hours', String(f.older_than_hours));
      params.set('limit', String(f.limit));
      params.set('offset', String(f.offset));
      try {
        const r = await fetch(`/admin/results-index?${params.toString()}`, { credentials: 'include' });
        if (!r.ok) { if (r.status === 403) { document.getElementById('admin_panel').style.display='none'; } throw new Error('HTTP '+r.status); }
        const j = await r.json();
        const items = j.items || [];
        const fmt = (n) => new Intl.NumberFormat().format(n||0);
        if (!items.length) { list.innerHTML = '<div class="text-gray-500">No results.</div>'; return; }
        let html = '<div class="text-gray-400" style="margin-bottom:.5rem;">Total: '+fmt(j.total)+' · Showing '+fmt(items.length)+(j.next_offset?(' · next_offset='+j.next_offset):'')+'</div>';
        html += '<div style="display:grid;grid-template-columns:1.2fr 1fr 0.8fr 0.6fr 1fr 0.6fr;gap:.35rem;align-items:center;">'
             + '<div class="text-sm text-gray-500">job_id / filename</div>'
             + '<div class="text-sm text-gray-500">modified_at</div>'
             + '<div class="text-sm text-gray-500">age_hours</div>'
             + '<div class="text-sm text-gray-500">size</div>'
             + '<div class="text-sm text-gray-500">owner</div>'
             + '<div class="text-sm text-gray-500">redis</div>';
        for (const it of items) {
          html += '<div class="text-xs">'+it.job_id+'<br/><span class="text-gray-400">'+it.filename+'</span></div>'
               + '<div class="text-xs text-gray-300">'+(it.modified_at||'')+'</div>'
               + '<div class="text-xs">'+(it.age_hours?it.age_hours.toFixed?it.age_hours.toFixed(1):it.age_hours:0)+'</div>'
               + '<div class="text-xs">'+fmt(it.size_bytes||0)+'</div>'
               + '<div class="text-xs">'+(it.owner_email||it.owner_id||'-')+'</div>'
               + '<div class="text-xs">'+(it.has_redis_copy?'yes':'no')+'</div>';
        }
        html += '</div>';
        list.innerHTML = html;
        if (j.next_offset != null) setOffset(j.next_offset);
      } catch (e) {
        list.innerHTML = `<div class="text-red-400">Failed to load index: ${e.message}</div>`;
      }
    }

    async function adminBulkDelete(dryRun) {
      const box = document.getElementById('bulk_delete_out');
      box.innerHTML = '<div class="text-gray-500">Processing…</div>';
      const filter = getFilters();
      try {
        if (!dryRun) {
          if (!confirm('정말 삭제하시겠습니까? 필터에 매칭되는 결과 파일을 삭제합니다.')) { box.innerHTML = '<div class="text-gray-500">Cancelled.</div>'; return; }
        }
        const r = await fetch('/admin/delete-results', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filter, dry_run: !!dryRun })
        });
        if (!r.ok) { if (r.status === 403) { document.getElementById('admin_panel').style.display='none'; } throw new Error('HTTP '+r.status); }
        const j = await r.json();
        const fmt = (n) => new Intl.NumberFormat().format(n||0);
        const count = j.deleted_count != null ? j.deleted_count : (j.would_delete_count || 0);
        const items = j.items || [];
        let html = '<div><b>'+ (dryRun ? 'Would delete' : 'Deleted') +'</b>: '+fmt(count)+' files · '+fmt(j.total_bytes||0)+' bytes</div>';
        if (items.length) {
          html += '<div style="margin-top:.35rem;max-height:180px;overflow:auto;">';
          for (const it of items) html += '<div class="text-xs text-gray-400">'+it.job_id+' · '+it.filename+' · '+fmt(it.bytes||0)+' bytes</div>';
          html += '</div>';
        }
        box.innerHTML = html;
        try { await adminLoadStats(); await adminLoadIndex(); } catch {}
      } catch (e) {
        box.innerHTML = `<div class=\"text-red-400\">Failed: ${e.message}</div>`;
      }
    }

    async function adminPruneNow() {
      const hours = parseInt(document.getElementById('prune_hours').value || '48', 10);
      if (!confirm(`Delete on-disk results older than ${hours}h?`)) return;
      try {
        const r = await fetch(`/admin/prune-results?older_than_hours=${encodeURIComponent(hours)}&dry_run=false`, { method: 'POST', credentials: 'include' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        alert(`Deleted ${j.deleted_count||0} files, ${new Intl.NumberFormat().format(j.total_bytes||0)} bytes`);
        try { await adminLoadStats(); await adminLoadIndex(); } catch {}
      } catch (e) {
        alert('Failed to prune: '+e.message);
      }
    }

    // Admin UI events
    document.getElementById('btn_storage_stats').addEventListener('click', adminLoadStats);
    document.getElementById('btn_results_load').addEventListener('click', adminLoadIndex);
    document.getElementById('btn_results_next').addEventListener('click', () => { const f = getFilters(); setOffset((f.offset||0) + (f.limit||50)); adminLoadIndex(); });
    document.getElementById('btn_results_prev').addEventListener('click', () => { const f = getFilters(); const step = (f.limit||50); setOffset(Math.max(0, (f.offset||0) - step)); adminLoadIndex(); });
    document.getElementById('btn_dry_run').addEventListener('click', () => adminBulkDelete(true));
    document.getElementById('btn_bulk_delete').addEventListener('click', () => adminBulkDelete(false));
    document.getElementById('btn_prune_now').addEventListener('click', adminPruneNow);
  </script>
</body>
</html>
