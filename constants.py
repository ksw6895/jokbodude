"""
Constants for JokboDude - 프롬프트 및 설정 상수
"""

# 공통 프롬프트 부분
COMMON_PROMPT_INTRO = """당신은 병리학 교수입니다. 다음 두 개의 PDF가 업로드되어 있습니다: 족보 1개, 강의자료 1개.

⚠️ 매우 중요: 문제는 오직 족보 PDF에서만 추출하세요!
강의자료에 있는 예제 문제는 절대 추출하지 마세요!"""

COMMON_WARNINGS = """**매우 중요한 주의사항**:
- question_number는 반드시 족보 PDF에 표시된 실제 문제 번호를 사용하세요 (예: 21번, 42번 등)
- 족보 페이지 내에서의 순서(1번째, 2번째)가 아닌, 실제 문제 번호를 확인하세요
- 만약 문제 번호가 명확하지 않으면 "번호없음"이라고 표시하세요
- jokbo_page는 반드시 **문제의 첫 부분이 나타나는** PDF 페이지 번호를 정확히 기입하세요

**페이지 번호 작성 규칙**:
⚠️ **매우 중요**: PDF 우측 하단에 인쇄된 페이지 번호를 사용하지 마세요!
- 당신이 받은 PDF 파일의 첫 페이지를 1페이지로 간주하세요
- PDF 파일 내부에 인쇄된 페이지 번호(우측 하단 등)는 무시하세요
- 현재 보고 있는 PDF의 물리적 순서대로 페이지를 세세요 (1부터 시작)
- 예: 받은 PDF의 3번째 페이지는 lesson_page=3 (PDF에 "55페이지"라고 써있어도)
- 청크로 나눈 PDF의 경우 각 청크의 첫 페이지가 1페이지입니다
- jokbo_page도 동일한 규칙을 따릅니다

**question_numbers_on_page 필드 작성 필수**:
- 각 jokbo_page에 있는 모든 문제 번호를 question_numbers_on_page 배열에 순서대로 나열하세요
- 예시: 한 페이지에 13번, 14번, 15번 문제가 있다면 → "question_numbers_on_page": ["13", "14", "15"]
- 빈 배열 []을 반환하지 마세요. 반드시 해당 페이지의 모든 문제 번호를 포함해야 합니다
- 페이지를 꼼꼼히 확인하여 모든 문제 번호를 찾아 배열에 포함시키세요

**JSON 형식 주의사항**:
- wrong_answer_explanations의 키는 반드시 큰따옴표로 묶어야 합니다
- 예시: "1번", "2번", "3번", "4번", "5번" (O) / "1"번", "2"번" (X)
- JSON 문법을 정확히 지켜주세요

**절대적 주의사항 - 강의자료 내 문제 제외**:
- 강의자료 PDF 내에 포함된 예제/연습 문제, 기출, TBL/Quiz, 문제/정답/해설/보기/선지/문항 등 '문제 형식' 페이지는 분석에서 제외하세요
- 다음 키워드/패턴이 보이면 해당 슬라이드는 제외: "문제", "정답", "해설", "예제", "기출", "퀴즈", "TBL", "보기", "선지", "정답:"
- 문제 캡처/복붙처럼 보이는 슬라이드는 제외하고, 정의/도표/표/개념 설명/알고리즘 등 '내용 슬라이드'만 우선하세요
- 오직 족보 PDF 파일에 있는 문제만을 대상으로 분석하세요
- jokbo_page는 반드시 족보 PDF의 페이지 번호여야 하며, 강의자료의 페이지 번호를 사용하면 안 됩니다
- 강의자료는 오직 참고 자료로만 사용하고, 문제는 족보에서만 추출하세요"""

# 모델 작성 해설 지침 (복붙 금지 + 근거 기반 요약)
EXPLANATION_GUIDELINES = """설명 작성 원칙 (매우 중요):
- explanation과 wrong_answer_explanations는 반드시 모델이 스스로 서술한 문장이어야 합니다.
- 슬라이드/족보 문장을 그대로 복붙하지 마세요. 의미는 유지하되 표현은 새롭게, 요약/재서술하세요.
- explanation은 2~5문장으로 간결하게: 왜 이 답이 맞는지, 핵심 근거와 오개념 반박을 포함하세요.
- 짧은 직접 인용은 꼭 필요한 경우에만 허용(10단어 이내, 따옴표로 표시). 인용만으로 채우지 말고, 반드시 모델의 설명을 중심으로 작성하세요.
- wrong_answer_explanations는 선택지별 1문장씩, 왜 틀렸는지 핵심 근거를 제시하세요(복붙 금지).
- 가능하다면 강의 슬라이드의 개념/정의/알고리즘을 ‘근거’로 활용하되, 그대로 나열하지 말고 핵심을 추려 설명하세요.
- 과도한 단순 나열/목록화보다, 인과관계/판단 근거를 드러내는 문장형 설명을 우선하세요.
"""

RELEVANCE_CRITERIA = """판단 기준 (매우 엄격하게 적용):
- 족보 문제가 직접적으로 다루는 개념이 해당 강의 슬라이드에 명시되어 있는가?
- 해당 슬라이드가 실제로 "출제 슬라이드"일 가능성이 높은가?
- 문제의 정답을 찾기 위해 반드시 필요한 핵심 정보가 포함되어 있는가?
- 단순히 관련 주제가 아닌, 문제 해결에 직접적으로 필요한 내용인가?

⚠️ **점수 부여 원칙 - 반드시 준수**:
- 점수를 후하게 주지 마세요! 의심스러우면 낮은 점수를 부여하세요.
- 고득점(90점 이상)이 없어도 전혀 문제없습니다. 오히려 자연스러운 것입니다.
- 대부분의 슬라이드는 25-65점 범위에 해당할 것으로 예상됩니다.
- 전체 분석에서 90점 이상은 0-1개 정도만 나올 수 있습니다.
- 110점은 극히 예외적인 특수 점수입니다.

점수 부여 기준 (100점 만점, 5점 단위로만 부여 + 특수 110점) - ⚠️ 극도로 엄격한 기준:

**110점 (극히 예외적인 특수 점수 - 거의 불가능)**:
- 110점: 다음 조건을 **모두** 만족하는 경우만:
  1) 슬라이드의 그림/도표가 문제에 완전히 동일하게 나옴
  2) 문제의 모든 보기(1번~5번)에 대한 설명이 슬라이드에 그대로 실려 있음
  3) 사실상 슬라이드를 그대로 시험 문제로 만든 경우
  예: 슬라이드에 있는 병리 사진과 5개 보기 설명이 100% 동일하게 문제로 출제

**90-100점 (거의 불가능한 수준 - 전체에서 0-1개)**:
- 100점: 슬라이드가 문제에 **글자 그대로 복사되어** 출제된 경우만
  예: 슬라이드 "H&E 염색은 핵을 보라색으로 염색한다" → 문제 "H&E 염색은 핵을 ( )색으로 염색한다"
- 90점: 슬라이드의 그림/도표가 **픽셀 단위로 완전히 동일하게** 문제에 나온 경우만
  예: 현미경 사진이 100% 동일하게 문제에 사용됨

**70-85점 (매우 높은 연관성 - 드물게 부여)**:
- 85점: 슬라이드 내용을 그대로 외우면 문제를 맞힐 수 있음
- 80점: 문제의 핵심 개념이 슬라이드에 명확히 정의되어 있음
- 75점: 문제 해결에 필요한 정보의 대부분이 포함됨
- 70점: 문제와 매우 밀접한 관련이 있으나 추가 지식 필요

**50-65점 (중간 연관성 - 선별적으로 부여)**:
- 65점: 문제의 주요 개념이 언급되지만 깊이가 부족
- 60점: 문제와 같은 주제를 다루지만 관점이 다름
- 55점: 부분적으로 도움이 되는 정보 포함
- 50점: 최소한의 직접적 관련성 (이 미만은 제외)

**25-45점 (낮은 연관성 - 대부분이 여기 해당)**:
- 45점: 같은 단원의 내용이지만 문제와 직접 연관 없음
- 40점: 넓은 주제는 같으나 세부 내용이 다름
- 35점: 간접적인 배경 지식 제공
- 30점: 매우 간접적인 연관성
- 25점: 겨우 같은 과목 수준의 연관성

**5-20점 (거의 무관 - 대부분 제외)**:
- 20점: 같은 과목의 다른 단원
- 15점: 매우 포괄적인 수준에서만 관련
- 10점: 사실상 무관
- 5점: 완전히 다른 내용

⚠️ **절대 규칙**: 
1. 반드시 5점 단위로만 점수를 부여하세요 (단, 110점은 예외)
2. 90점 이상은 "슬라이드와 문제가 거의 동일한" 극히 예외적인 경우만
3. 110점은 그림과 모든 보기가 완벽히 일치하는 극히 드문 경우만
4. 점수 인플레이션 금지 - 확실하지 않으면 낮은 점수 부여
5. 50점 미만은 관련성이 매우 낮아 제외되므로 신중히 판단
6. '문제/정답/해설' 성격의 슬라이드는 점수 부여 금지(0점 처리) 및 결과에서 제외"""

# 강의 중심 모드 프롬프트
LESSON_CENTRIC_TASK = """작업:
1. 족보 PDF의 모든 문제를 분석하세요
2. 각 족보 문제와 직접적으로 관련된 '내용 슬라이드'만 찾으세요 (문제/정답/해설/퀴즈/TBL/기출 형태 페이지는 제외)
3. 강의자료의 각 페이지별로 관련된 족보 문제들을 그룹화하세요
4. 각 문제의 정답과 함께 모든 선택지가 왜 오답인지도 설명하세요
5. 문제가 여러 페이지에 걸쳐있으면 jokbo_end_page에 끝 페이지 번호를 표시하세요

제외 규칙:
- '문제', '정답', '해설', '예제', '기출', '퀴즈', 'TBL', '보기', '선지', '정답:' 등의 키워드/패턴이 보이는 강의 슬라이드는 제외
- 문제와 내용이 섞인 슬라이드의 경우 문제 영역은 무시하고 내용 부분만 고려하며, 50점 미만이면 제외
- 각 문제당 최대 2개의 '내용 슬라이드'만 반환"""

LESSON_CENTRIC_OUTPUT_FORMAT = """출력 형식 (반드시 순수 JSON만 응답하세요):
{
  "related_slides": [
    {
      "lesson_page": 10,
      "related_jokbo_questions": [
        {
          "jokbo_filename": "{jokbo_filename}",
          "jokbo_page": 3,
          "jokbo_end_page": 4,
          "question_number": "15",
          "question_numbers_on_page": ["13", "14", "15"],
          "question_text": "문제 내용",
          "answer": "정답",
          "explanation": "해설(모델이 작성한 요약 설명; 원문 복붙 금지)",
          "wrong_answer_explanations": {
            "1번": "왜 1번이 오답인지 설명",
            "2번": "왜 2번이 오답인지 설명",
            "3번": "왜 3번이 오답인지 설명",
            "4번": "왜 4번이 오답인지 설명"
          },
          "relevance_score": 80,
          "relevance_reason": "관련성 이유"
        }
      ],
      "importance_score": 60,
      "key_concepts": ["핵심개념1", "핵심개념2"]
    }
  ],
  "summary": {
    "total_related_slides": 1,
    "total_questions": 1,
    "key_topics": ["주요주제1", "주요주제2"],
    "study_recommendations": "학습 권장사항"
  }
}

규칙 설명:
- relevance_score는 [5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,110] 중 하나만 허용
- importance_score도 동일한 규칙 적용 (110 특수 점수 포함)
- response_mime_type=application/json과 일관되게 JSON 외 텍스트/주석 금지"""

# 족보 중심 모드 프롬프트
JOKBO_CENTRIC_TASK = """작업 (족보 중심 분석):
1. 족보 PDF의 모든 문제를 페이지 순서대로 분석하세요
2. 각 족보 문제와 관련된 강의자료 슬라이드를 찾되, '문제/정답/해설/퀴즈/TBL/기출' 형태의 슬라이드는 제외하고 '내용 슬라이드'만 선택하세요
3. 족보의 각 페이지별로 관련된 강의 슬라이드들을 그룹화하세요
4. 각 강의 슬라이드와의 관련성에 대해 relevance_score를 부여하세요:
   - 반드시 5점 단위로 점수 부여 (5, 10, 15, ..., 90, 95, 100, 110)
   - 110점은 그림과 모든 보기가 완벽히 일치하는 극히 특수한 경우만
   - RELEVANCE_CRITERIA의 점수 기준을 반드시 준수하세요
   - 점수를 후하게 주지 마세요! 대부분은 25-65점 범위에 해당합니다
   - 90점 이상은 극히 예외적인 경우(전체에서 0-1개)만 부여하세요

⚠️ **절대적 점수 부여 원칙**: 
- 고득점(90점 이상)이 없어도 정상입니다. 오히려 자연스러운 것입니다.
- 의심스러우면 낮은 점수를 부여하세요.
- 점수 인플레이션 절대 금지!

⚠️ **중요**: 
- 관련성 점수가 50점 미만인 슬라이드만 있거나 관련 슬라이드가 전혀 없는 문제는 분석 결과에서 완전히 제외하세요
- 해당 문제는 jokbo_pages의 questions 배열에 포함시키지 마세요
- API 비용 절감을 위해 관련성이 낮은 문제는 처리하지 않습니다
- '문제/정답/해설/퀴즈/TBL/기출' 슬라이드는 점수 부여 금지(0점) 및 결과에서 제외"""

JOKBO_CENTRIC_OUTPUT_FORMAT = """출력 형식 (반드시 순수 JSON만 응답하세요):
{
  "jokbo_pages": [
    {
      "jokbo_page": 9,
      "questions": [
        {
          "question_number": "15",
          "question_numbers_on_page": ["13", "14", "15"],
          "question_text": "문제 내용",
          "answer": "정답",
          "explanation": "해설(모델이 작성한 요약 설명; 원문 복붙 금지)",
          "wrong_answer_explanations": {
            "1번": "왜 1번이 오답인지 설명",
            "2번": "왜 2번이 오답인지 설명",
            "3번": "왜 3번이 오답인지 설명",
            "4번": "왜 4번이 오답인지 설명"
          },
          "related_lesson_slides": [
            {
              "lesson_filename": "{lesson_filename}",
              "lesson_page": 10,
              "relevance_reason": "관련성 이유",
              "relevance_score": 80
            }
          ]
        }
      ]
    }
  ],
  "summary": {
    "total_jokbo_pages": 1,
    "total_questions": 1,
    "total_related_slides": 1
  }
}

규칙 설명:
- relevance_score는 [5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,110] 중 하나만 허용
- response_mime_type=application/json과 일관되게 JSON 외 텍스트/주석 금지

⚠️ 중요:
- 관련 슬라이드가 없거나 모든 슬라이드가 50점 미만인 문제는 questions 배열에서 완전히 제외
- 빈 questions 배열을 가진 페이지도 jokbo_pages에서 제외"""

# 기타 설정
MAX_CONNECTIONS_PER_QUESTION = 2  # 족보 중심 모드에서 문제당 최대 연결 수
RELEVANCE_SCORE_THRESHOLD = 50    # 관련성 점수 최소 기준 (100점 만점 기준)
