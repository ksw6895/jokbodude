# Jokbodude 코드 분석 보고서

## 프로젝트 개요
- 족보(기출문제)를 기반으로 강의자료를 필터링하는 PDF 처리 시스템
- Google Gemini AI API를 사용하여 강의 슬라이드와 시험 문제 간의 연관성 분석
- 두 가지 모드 지원: 강의자료 중심, 족보 중심

## 주요 발견사항

### 1. 심각한 버그 및 오류 가능성

#### 1.1 파일 업로드 관리 문제
**위치**: `pdf_processor.py`
- **문제**: `delete_all_uploaded_files()` 메서드가 모든 파일을 삭제하는데, 이는 동시에 실행되는 다른 프로세스의 파일도 삭제할 위험이 있음
- **영향도**: 높음 - 병렬 처리 시 다른 스레드의 파일이 삭제되어 처리 실패 가능성
- **개선안**: 해당 인스턴스가 업로드한 파일만 추적하여 삭제

#### 1.2 PDF 파일 핸들 누수
**위치**: `pdf_creator.py`
- **문제**: `extract_lesson_slide()` 메서드에서 예외 발생 시 PDF 파일이 닫히지 않음
```python
# Line 175-179
lesson_pdf = fitz.open(str(lesson_path))
if lesson_page > len(lesson_pdf) or lesson_page < 1:
    print(f"Warning: Page {lesson_page} does not exist in {lesson_filename}")
    lesson_pdf.close()  # 정상 케이스에서만 닫힘
    return None
# 예외 발생 시 파일이 닫히지 않음
```
- **영향도**: 중간 - 메모리 누수 및 파일 잠금 문제 발생 가능

#### 1.3 스레드 안전성 문제
**위치**: `pdf_processor.py` (병렬 처리 메서드들)
- **문제**: 여러 스레드가 동시에 `self.model`을 사용하지만 스레드 안전성 보장 없음
- **영향도**: 중간 - Google AI SDK가 스레드 안전하지 않을 경우 예측 불가능한 동작 가능

### 2. 비효율적인 구현

#### 2.1 중복된 프롬프트 코드
**위치**: `pdf_processor.py`
- **문제**: 거의 동일한 프롬프트가 여러 메서드에 하드코딩되어 있음
  - `analyze_single_jokbo_with_lesson()` (156-227줄)
  - `analyze_single_jokbo_with_lesson_preloaded()` (289-360줄)
  - `analyze_single_lesson_with_jokbo()` (486-539줄)
  - `analyze_single_lesson_with_jokbo_preloaded()` (636-689줄)
- **영향도**: 낮음 - 유지보수성 저하
- **개선안**: 프롬프트 템플릿을 별도 상수로 관리

#### 2.2 비효율적인 PDF 캐싱
**위치**: `pdf_creator.py`
- **문제**: `jokbo_pdfs` 딕셔너리가 모든 족보 PDF를 메모리에 유지
- **영향도**: 중간 - 대량의 PDF 처리 시 메모리 사용량 급증
- **개선안**: LRU 캐시 또는 필요시 로드 방식 고려

#### 2.3 하드코딩된 설정값
**위치**: 여러 파일
- **문제**: 
  - 모델명 "gemini-2.5-pro" 하드코딩
  - max_workers=3 하드코딩
  - 폰트 설정 하드코딩
- **영향도**: 낮음 - 유연성 부족
- **개선안**: 설정 파일로 분리

### 3. 오류 처리 개선 필요

#### 3.1 JSON 파싱 오류 처리
**위치**: `pdf_processor.py`
- **문제**: JSON 파싱 실패 시 단순히 에러 메시지만 출력하고 계속 진행
```python
except json.JSONDecodeError:
    print(f"Failed to parse JSON response: {response.text}")
    return {"error": "Failed to parse response"}
```
- **영향도**: 중간 - 오류 원인 파악 어려움
- **개선안**: 재시도 로직 또는 더 자세한 오류 정보 제공

#### 3.2 파일 삭제 실패 무시
**위치**: `pdf_processor.py`
- **문제**: `delete_file_safe()` 메서드에서 실패 후 무작정 모든 족보 파일 삭제 시도
- **영향도**: 높음 - 의도하지 않은 파일 삭제 가능

### 4. 성능 최적화 기회

#### 4.1 불필요한 파일 업로드
**위치**: `pdf_processor.py`
- **문제**: 병렬 처리 모드에서도 각 스레드가 독립적인 PDFProcessor 인스턴스 생성
- **영향도**: 중간 - API 호출 비용 증가
- **개선안**: 파일 업로드 결과 공유 메커니즘 구현

#### 4.2 페이지 검증 중복
**위치**: `pdf_processor.py`
- **문제**: 각 분석 결과마다 동일한 페이지 범위 검증 반복
- **영향도**: 낮음 - 미미한 성능 저하

### 5. 보안 및 안정성 문제

#### 5.1 API 키 노출 위험
**위치**: `config.py`
- **문제**: API 키 검증이 애플리케이션 시작 시에만 수행됨
- **영향도**: 낮음 - 런타임 중 환경 변수 변경 감지 불가

#### 5.2 임시 파일 관리
**위치**: `pdf_creator.py`
- **문제**: `temp_files` 리스트가 사용되지 않음 (빈 리스트로 유지)
- **영향도**: 낮음 - 불필요한 코드

### 6. 사용자 경험 개선 필요

#### 6.1 진행 상황 표시 부족
- **문제**: 대량 파일 처리 시 진행률 표시 없음
- **영향도**: 낮음 - 사용자가 프로그램이 멈춘 것으로 오인 가능

#### 6.2 에러 메시지 일관성
- **문제**: 한국어와 영어 메시지 혼재
- **영향도**: 낮음 - 사용자 혼란 가능

## 권장 개선 우선순위

### 즉시 수정 필요 (높음)
1. 파일 업로드 관리 개선 - 인스턴스별 파일 추적
2. PDF 파일 핸들 누수 수정 - try-finally 또는 context manager 사용
3. 파일 삭제 로직 개선 - 무작정 삭제 방지

### 중기 개선 사항 (중간)
1. 스레드 안전성 보장
2. 프롬프트 템플릿 분리
3. PDF 캐싱 메커니즘 개선
4. JSON 파싱 오류 처리 강화

### 장기 개선 사항 (낮음)
1. 설정 파일 도입
2. 진행률 표시 추가
3. 코드 중복 제거
4. 로깅 시스템 도입

## 결론
전반적으로 기능은 잘 구현되어 있으나, 안정성과 확장성 측면에서 개선이 필요합니다. 특히 병렬 처리 시 발생할 수 있는 파일 관리 문제와 리소스 누수 문제를 우선적으로 해결해야 합니다.